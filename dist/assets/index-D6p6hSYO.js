var Ye=Object.defineProperty;var $e=(r,e,t)=>e in r?Ye(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var h=(r,e,t)=>$e(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const Y=23283064365386963e-26;class le{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*Y,e=e*69069+1>>>0,this._s1=e*Y,e=e*69069+1>>>0,this._s2=e*Y,this._c=1,this}getUniform(){let e=2091639*this._s0+this._c*Y;return this._s0=this._s1,this._s1=this._s2,this._c=e|0,this._s2=e-this._c,this._s2}getUniformInt(e,t){let i=Math.max(e,t),s=Math.min(e,t);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(e=0,t=1){let i,s,n;do i=2*this.getUniform()-1,s=2*this.getUniform()-1,n=i*i+s*s;while(n>1||n==0);let l=i*Math.sqrt(-2*Math.log(n)/n);return e+l*t}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(e){return e.length?e[Math.floor(this.getUniform()*e.length)]:null}shuffle(e){let t=[],i=e.slice();for(;i.length;){let s=i.indexOf(this.getItem(i));t.push(i.splice(s,1)[0])}return t}getWeightedValue(e){let t=0;for(let l in e)t+=e[l];let i=this.getUniform()*t,s,n=0;for(s in e)if(n+=e[s],i<n)return s;return s}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this}clone(){return new le().setState(this.getState())}}const V=new le().setSeed(Date.now());class ae{getContainer(){return null}setOptions(e){this._options=e}}class oe extends ae{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(e){requestAnimationFrame(e)}getContainer(){return this._ctx.canvas}setOptions(e){super.setOptions(e);const i=`${e.fontStyle?`${e.fontStyle} `:""} ${e.fontSize}px ${e.fontFamily}`;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const e=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=e}eventToPosition(e,t){let i=this._ctx.canvas,s=i.getBoundingClientRect();return e-=s.left,t-=s.top,e*=i.width/s.width,t*=i.height/s.height,e<0||t<0||e>=i.width||t>=i.height?[-1,-1]:this._normalizedEventToPosition(e,t)}}function He(r,e){return(r%e+e)%e}function xe(r,e=0,t=1){return r<e?e:r>t?t:r}class be extends oe{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(e,t){let[i,s,n,l,a]=e,o=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&o.reverse(),t&&(this._ctx.fillStyle=a,this._fill(o[0],o[1])),!n)return;this._ctx.fillStyle=l;let c=[].concat(n);for(let u=0;u<c.length;u++)this._ctx.fillText(c[u],o[0],Math.ceil(o[1]))}computeSize(e,t){this._options.transpose&&(e+=t,t=e-t,e-=t);let i=Math.floor(e/this._spacingX)-1,s=Math.floor((t-2*this._hexSize)/this._spacingY+1);return[i,s]}computeFontSize(e,t){this._options.transpose&&(e+=t,t=e-t,e-=t);let i=2*e/((this._options.width+1)*Math.sqrt(3))-1,s=t/(2+1.5*(this._options.height-1)),n=Math.min(i,s),l=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=l;let o=a/100;n=Math.floor(n)+1;let c=2*n/(this._options.spacing*(1+o/Math.sqrt(3)));return Math.ceil(c)-1}_normalizedEventToPosition(e,t){let i;this._options.transpose?(e+=t,t=e-t,e-=t,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return t=Math.floor(t/s),He(t,2)?(e-=this._spacingX,e=1+2*Math.floor(e/(2*this._spacingX))):e=2*Math.floor(e/(2*this._spacingX)),[e,t]}_fill(e,t){let i=this._hexSize,s=this._options.border;const n=this._ctx;n.beginPath(),this._options.transpose?(n.moveTo(e-i+s,t),n.lineTo(e-i/2+s,t+this._spacingX-s),n.lineTo(e+i/2-s,t+this._spacingX-s),n.lineTo(e+i-s,t),n.lineTo(e+i/2-s,t-this._spacingX+s),n.lineTo(e-i/2+s,t-this._spacingX+s),n.lineTo(e-i+s,t)):(n.moveTo(e,t-i+s),n.lineTo(e+this._spacingX-s,t-i/2+s),n.lineTo(e+this._spacingX-s,t+i/2-s),n.lineTo(e,t+i-s),n.lineTo(e-this._spacingX+s,t+i/2-s),n.lineTo(e-this._spacingX+s,t-i/2+s),n.lineTo(e,t-i+s)),n.fill()}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(e.spacing*(e.fontSize+t/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=this._hexSize*1.5;let i,s;e.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((e.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((e.height-1)*this._spacingY+2*this._hexSize)}}class z extends oe{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(e){super.setOptions(e),this._canvasCache={}}draw(e,t){z.cache?this._drawWithCache(e):this._drawNoCache(e,t)}_drawWithCache(e){let[t,i,s,n,l]=e,a=""+s+n+l,o;if(a in this._canvasCache)o=this._canvasCache[a];else{let c=this._options.border;o=document.createElement("canvas");let u=o.getContext("2d");if(o.width=this._spacingX,o.height=this._spacingY,u.fillStyle=l,u.fillRect(c,c,o.width-c,o.height-c),s){u.fillStyle=n,u.font=this._ctx.font,u.textAlign="center",u.textBaseline="middle";let f=[].concat(s);for(let _=0;_<f.length;_++)u.fillText(f[_],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=o}this._ctx.drawImage(o,t*this._spacingX,i*this._spacingY)}_drawNoCache(e,t){let[i,s,n,l,a]=e;if(t){let c=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(i*this._spacingX+c,s*this._spacingY+c,this._spacingX-c,this._spacingY-c)}if(!n)return;this._ctx.fillStyle=l;let o=[].concat(n);for(let c=0;c<o.length;c++)this._ctx.fillText(o[c],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(e,t){let i=Math.floor(e/this._spacingX),s=Math.floor(t/this._spacingY);return[i,s]}computeFontSize(e,t){let i=Math.floor(e/this._options.width),s=Math.floor(t/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let l=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let o=l/100*s/i;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(e.spacing*t),this._spacingY=Math.ceil(e.spacing*e.fontSize),e.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=e.width*this._spacingX,this._ctx.canvas.height=e.height*this._spacingY}}z.cache=!1;class Ee extends oe{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(e,t){let[i,s,n,l,a]=e,o=this._options.tileWidth,c=this._options.tileHeight;if(t&&(this._options.tileColorize?this._ctx.clearRect(i*o,s*c,o,c):(this._ctx.fillStyle=a,this._ctx.fillRect(i*o,s*c,o,c))),!n)return;let u=[].concat(n),f=[].concat(l),_=[].concat(a);for(let d=0;d<u.length;d++){let g=this._options.tileMap[u[d]];if(!g)throw new Error(`Char "${u[d]}" not found in tileMap`);if(this._options.tileColorize){let w=this._colorCanvas,b=w.getContext("2d");b.globalCompositeOperation="source-over",b.clearRect(0,0,o,c);let I=f[d],S=_[d];b.drawImage(this._options.tileSet,g[0],g[1],o,c,0,0,o,c),I!="transparent"&&(b.fillStyle=I,b.globalCompositeOperation="source-atop",b.fillRect(0,0,o,c)),S!="transparent"&&(b.fillStyle=S,b.globalCompositeOperation="destination-over",b.fillRect(0,0,o,c)),this._ctx.drawImage(w,i*o,s*c,o,c)}else this._ctx.drawImage(this._options.tileSet,g[0],g[1],o,c,i*o,s*c,o,c)}}computeSize(e,t){let i=Math.floor(e/this._options.tileWidth),s=Math.floor(t/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._options;this._ctx.canvas.width=e.width*e.tileWidth,this._ctx.canvas.height=e.height*e.tileHeight,this._colorCanvas.width=e.tileWidth,this._colorCanvas.height=e.tileHeight}}function he(r){let e,t;if(r in ee)e=ee[r];else{if(r.charAt(0)=="#"){let s=(r.match(/[0-9a-f]/gi)||[]).map(n=>parseInt(n,16));if(s.length==3)e=s.map(n=>n*17);else{for(let n=0;n<3;n++)s[n+1]+=16*s[n],s.splice(n,1);e=s}}else(t=r.match(/rgb\(([0-9, ]+)\)/i))?e=t[1].split(/\s*,\s*/).map(i=>parseInt(i)):e=[0,0,0];ee[r]=e}return e.slice()}function Ge(r,...e){let t=r.slice();for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function We(r,...e){for(let t=0;t<3;t++)for(let i=0;i<e.length;i++)r[t]+=e[i][t];return r}function qe(r,...e){let t=r.slice();for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function je(r,...e){for(let t=0;t<3;t++){for(let i=0;i<e.length;i++)r[t]*=e[i][t]/255;r[t]=Math.round(r[t])}return r}function Ie(r,e,t=.5){let i=r.slice();for(let s=0;s<3;s++)i[s]=Math.round(i[s]+t*(e[s]-r[s]));return i}const Je=Ie;function Le(r,e,t=.5){let i=ie(r),s=ie(e);for(let n=0;n<3;n++)i[n]+=t*(s[n]-i[n]);return Se(i)}const Qe=Le;function Ze(r,e){e instanceof Array||(e=Math.round(V.getNormal(0,e)));let t=r.slice();for(let i=0;i<3;i++)t[i]+=e instanceof Array?Math.round(V.getNormal(0,e[i])):e;return t}function ie(r){let e=r[0]/255,t=r[1]/255,i=r[2]/255,s=Math.max(e,t,i),n=Math.min(e,t,i),l=0,a,o=(s+n)/2;if(s==n)a=0;else{let c=s-n;switch(a=o>.5?c/(2-s-n):c/(s+n),s){case e:l=(t-i)/c+(t<i?6:0);break;case t:l=(i-e)/c+2;break;case i:l=(e-t)/c+4;break}l/=6}return[l,a,o]}function Z(r,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?r+(e-r)*6*t:t<1/2?e:t<2/3?r+(e-r)*(2/3-t)*6:r}function Se(r){let e=r[2];if(r[1]==0)return e=Math.round(e*255),[e,e,e];{let t=r[1],i=e<.5?e*(1+t):e+t-e*t,s=2*e-i,n=Z(s,i,r[0]+1/3),l=Z(s,i,r[0]),a=Z(s,i,r[0]-1/3);return[Math.round(n*255),Math.round(l*255),Math.round(a*255)]}}function et(r){return`rgb(${r.map(t=>xe(t,0,255)).join(",")})`}function tt(r){return`#${r.map(t=>xe(t,0,255).toString(16).padStart(2,"0")).join("")}`}const ee={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]},it=Object.freeze(Object.defineProperty({__proto__:null,add:Ge,add_:We,fromString:he,hsl2rgb:Se,interpolate:Ie,interpolateHSL:Le,lerp:Je,lerpHSL:Qe,multiply:qe,multiply_:je,randomize:Ze,rgb2hsl:ie,toHex:tt,toRGB:et},Symbol.toStringTag,{value:"Module"}));class Ve extends ae{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(e){typeof e=="string"?alert(e):e instanceof Error&&alert(e.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(e){requestAnimationFrame(e)}getContainer(){return this._gl.canvas}setOptions(e){super.setOptions(e),this._updateSize();let t=this._options.tileSet;t&&"complete"in t&&!t.complete?t.addEventListener("load",()=>this._updateTexture(t)):this._updateTexture(t)}draw(e,t){const i=this._gl,s=this._options;let[n,l,a,o,c]=e,u=i.canvas.height-(l+1)*s.tileHeight;if(i.scissor(n*s.tileWidth,u,s.tileWidth,s.tileHeight),t&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...$(c)),i.clear(i.COLOR_BUFFER_BIT)),!a)return;let f=[].concat(a),_=[].concat(c),d=[].concat(o);i.uniform2fv(this._uniforms.targetPosRel,[n,l]);for(let g=0;g<f.length;g++){let w=this._options.tileMap[f[g]];if(!w)throw new Error(`Char "${f[g]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,w),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,$(d[g])),i.uniform4fv(this._uniforms.bg,$(_[g]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const e=this._gl;e.clearColor(...$(this._options.bg)),e.scissor(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}computeSize(e,t){let i=Math.floor(e/this._options.tileWidth),s=Math.floor(t/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(e,t){let i=this._gl.canvas,s=i.getBoundingClientRect();return e-=s.left,t-=s.top,e*=i.width/s.width,t*=i.height/s.height,e<0||t<0||e>=i.width||t>=i.height?[-1,-1]:this._normalizedEventToPosition(e,t)}_initWebGL(){let e=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=e;let t=lt(e,rt,nt);return e.useProgram(t),at(e),st.forEach(i=>this._uniforms[i]=e.getUniformLocation(t,i)),this._program=t,e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.SCISSOR_TEST),e}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._gl,t=this._options,i=[t.width*t.tileWidth,t.height*t.tileHeight];e.canvas.width=i[0],e.canvas.height=i[1],e.viewport(0,0,i[0],i[1]),e.uniform2fv(this._uniforms.tileSize,[t.tileWidth,t.tileHeight]),e.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(e){ot(this._gl,e)}}const st=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],rt=`
#version 300 es

in vec2 tilePosRel;
out vec2 tilesetPosPx;

uniform vec2 tilesetPosAbs;
uniform vec2 tileSize;
uniform vec2 targetSize;
uniform vec2 targetPosRel;

void main() {
	vec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;
	vec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;
	targetPosNdc.y *= -1.0;

	gl_Position = vec4(targetPosNdc, 0.0, 1.0);
	tilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;
}`.trim(),nt=`
#version 300 es
precision highp float;

in vec2 tilesetPosPx;
out vec4 fragColor;
uniform sampler2D image;
uniform bool colorize;
uniform vec4 bg;
uniform vec4 tint;

void main() {
	fragColor = vec4(0, 0, 0, 1);

	vec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);

	if (colorize) {
		texel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;
		fragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;
		fragColor.a = texel.a + (1.0-texel.a)*bg.a;
	} else {
		fragColor = texel;
	}
}`.trim();function lt(r,e,t){const i=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(i)||"");const s=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(s,t),r.compileShader(s),!r.getShaderParameter(s,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(s)||"");const n=r.createProgram();if(r.attachShader(n,i),r.attachShader(n,s),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(n)||"");return n}function at(r){const e=new Float32Array([0,0,1,0,0,1,1,1]),t=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW),r.enableVertexAttribArray(0),r.vertexAttribPointer(0,2,r.FLOAT,!1,0,0)}function ot(r,e){let t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.REPEAT),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),t}let te={};function $(r){if(!(r in te)){let e;if(r=="transparent")e=[0,0,0,0];else if(r.indexOf("rgba")>-1){e=(r.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=he(r).map(t=>t/255),e.push(1);te[r]=e}return te[r]}function ht(r){return`\x1B[0;48;5;${se(r)}m\x1B[2J`}function ct(r,e){return`\x1B[0;38;5;${se(r)};48;5;${se(e)}m`}function ut(r,e){return`\x1B[${e+1};${r+1}H`}function se(r){const i=.0234375;let s=he(r),n=Math.floor(s[0]*i),l=Math.floor(s[1]*i),a=Math.floor(s[2]*i);return n*36+l*6+a*1+16}class Te extends ae{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(e){setTimeout(e,1e3/60)}setOptions(e){super.setOptions(e);let t=[e.width,e.height],i=this.computeSize();this._offset=i.map((s,n)=>Math.floor((s-t[n])/2))}clear(){process.stdout.write(ht(this._options.bg))}draw(e,t){let[i,s,n,l,a]=e,o=this._offset[0]+i,c=this._offset[1]+s,u=this.computeSize();if(o<0||o>=u[0]||c<0||c>=u[1]||((o!==this._cursor[0]||c!==this._cursor[1])&&(process.stdout.write(ut(o,c)),this._cursor[0]=o,this._cursor[1]=c),t&&(n||(n=" ")),!n))return;let f=ct(l,a);if(f!==this._lastColor&&(process.stdout.write(f),this._lastColor=f),n!="	"){let _=[].concat(n);process.stdout.write(_[0])}this._cursor[0]++,this._cursor[0]>=u[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(e,t){return[e,t]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const ft=/%([bc]){([^}]*)}/g,B=0,D=1,Oe=2,Ke=3;function dt(r,e){let t=[],i=0;r.replace(ft,function(n,l,a,o){let c=r.substring(i,o);return c.length&&t.push({type:B,value:c}),t.push({type:l=="c"?Oe:Ke,value:a.trim()}),i=o+n.length,""});let s=r.substring(i);return s.length&&t.push({type:B,value:s}),gt(t,e)}function gt(r,e){e||(e=1/0);let t=0,i=0,s=-1;for(;t<r.length;){let l=r[t];if(l.type==D&&(i=0,s=-1),l.type!=B){t++;continue}for(;i==0&&l.value.charAt(0)==" ";)l.value=l.value.substring(1);let a=l.value.indexOf(`
`);if(a!=-1){l.value=H(r,t,a,!0);let o=l.value.split("");for(;o.length&&o[o.length-1]==" ";)o.pop();l.value=o.join("")}if(!l.value.length){r.splice(t,1);continue}if(i+l.value.length>e){let o=-1;for(;;){let c=l.value.indexOf(" ",o+1);if(c==-1||i+c>e)break;o=c}if(o!=-1)l.value=H(r,t,o,!0);else if(s!=-1){let c=r[s],u=c.value.lastIndexOf(" ");c.value=H(r,s,u,!0),t=s}else l.value=H(r,t,e-i,!1)}else i+=l.value.length,l.value.indexOf(" ")!=-1&&(s=t);t++}r.push({type:D});let n=null;for(let l=0;l<r.length;l++){let a=r[l];switch(a.type){case B:n=a;break;case D:if(n){let o=n.value.split("");for(;o.length&&o[o.length-1]==" ";)o.pop();n.value=o.join("")}n=null;break}}return r.pop(),r}function H(r,e,t,i){let s={type:D},n={type:B,value:r[e].value.substring(t+(i?1:0))};return r.splice(e+1,0,s,n),r[e].value.substring(0,t)}let _t=80,pt=25;const T={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},v={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},vt={hex:be,rect:z,tile:Ee,"tile-gl":Ve,term:Te},mt={width:_t,height:pt,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class N{constructor(e={}){this._data={},this._dirty=!1,this._options={},e=Object.assign({},mt,e),this.setOptions(e),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(e,t,i){let s=[this._options.bg,this._options.fg];this.draw(e,t,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(e){if(Object.assign(this._options,e),e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){if(e.layout){let t=vt[e.layout];this._backend=new t}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(e,t){return this._backend.computeSize(e,t)}computeFontSize(e,t){return this._backend.computeFontSize(e,t)}computeTileSize(e,t){let i=Math.floor(e/this._options.width),s=Math.floor(t/this._options.height);return[i,s]}eventToPosition(e){let t,i;return"touches"in e?(t=e.touches[0].clientX,i=e.touches[0].clientY):(t=e.clientX,i=e.clientY),this._backend.eventToPosition(t,i)}draw(e,t,i,s,n){s||(s=this._options.fg),n||(n=this._options.bg);let l=`${e},${t}`;this._data[l]=[e,t,i,s,n],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[l]=!0)}drawOver(e,t,i,s,n){const l=`${e},${t}`,a=this._data[l];a?(a[2]=i||a[2],a[3]=s||a[3],a[4]=n||a[4]):this.draw(e,t,i,s,n)}drawText(e,t,i,s){let n=null,l=null,a=e,o=t,c=1;s||(s=this._options.width-e);let u=dt(i,s);for(;u.length;){let f=u.shift();switch(f.type){case B:let _=!1,d=!1,g=!1,w=!1;for(let b=0;b<f.value.length;b++){let I=f.value.charCodeAt(b),S=f.value.charAt(b);if(this._options.layout==="term"){let P=I>>8;if(P===17||P>=46&&P<=159||P>=172&&P<=215||I>=43360&&I<=43391){this.draw(a+0,o,S,n,l),this.draw(a+1,o,"	",n,l),a+=2;continue}}g=I>65280&&I<65377||I>65500&&I<65512||I>65518,_=S.charCodeAt(0)==32||S.charCodeAt(0)==12288,w&&!g&&!_&&a++,g&&!d&&a++,this.draw(a++,o,S,n,l),d=_,w=g}break;case Oe:n=f.value||null;break;case Ke:l=f.value||null;break;case D:a=e,o++,c++;break}}return c}_tick(){if(this._backend.schedule(this._tick),!!this._dirty){if(this._dirty===!0){this._backend.clear();for(let e in this._data)this._draw(e,!1)}else for(let e in this._dirty)this._draw(e,!0);this._dirty=!1}}_draw(e,t){let i=this._data[e];i[4]!=this._options.bg&&(t=!0),this._backend.draw(i,t)}}N.Rect=z;N.Hex=be;N.Tile=Ee;N.TileGL=Ve;N.Term=Te;class ge{constructor(){this.heap=[],this.timestamp=0}lessThan(e,t){return e.key==t.key?e.timestamp<t.timestamp:e.key<t.key}shift(e){this.heap=this.heap.map(({key:t,value:i,timestamp:s})=>({key:t+e,value:i,timestamp:s}))}len(){return this.heap.length}push(e,t){this.timestamp+=1;const i=this.len();this.heap.push({value:e,timestamp:this.timestamp,key:t}),this.updateUp(i)}pop(){if(this.len()==0)throw new Error("no element to pop");const e=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),e}find(e){for(let t=0;t<this.len();t++)if(e==this.heap[t].value)return this.heap[t];return null}remove(e){let t=null;for(let i=0;i<this.len();i++)e==this.heap[i].value&&(t=i);if(t===null)return!1;if(this.len()>1){let i=this.heap.pop();return i.value!=e&&(this.heap[t]=i,this.updateDown(t)),!0}else this.heap.pop();return!0}parentNode(e){return Math.floor((e-1)/2)}leftChildNode(e){return 2*e+1}rightChildNode(e){return 2*e+2}existNode(e){return e>=0&&e<this.heap.length}swap(e,t){const i=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=i}minNode(e){const t=e.filter(this.existNode.bind(this));let i=t[0];for(const s of t)this.lessThan(this.heap[s],this.heap[i])&&(i=s);return i}updateUp(e){if(e==0)return;const t=this.parentNode(e);this.existNode(t)&&this.lessThan(this.heap[e],this.heap[t])&&(this.swap(e,t),this.updateUp(t))}updateDown(e){const t=this.leftChildNode(e),i=this.rightChildNode(e);if(!this.existNode(t))return;const s=this.minNode([e,t,i]);s!=e&&(this.swap(e,s),this.updateDown(s))}debugPrint(){console.log(this.heap)}}class wt{constructor(){this._time=0,this._events=new ge}getTime(){return this._time}clear(){return this._events=new ge,this}add(e,t){this._events.push(e,t)}get(){if(!this._events.len())return null;let{key:e,value:t}=this._events.pop();return e>0&&(this._time+=e,this._events.shift(-e)),t}getEventTime(e){const t=this._events.find(e);if(t){const{key:i}=t;return i}}remove(e){return this._events.remove(e)}}class ce{constructor(){this._queue=new wt,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(e,t){return t&&this._repeat.push(e),this}getTimeOf(e){return this._queue.getEventTime(e)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(e){let t=this._queue.remove(e),i=this._repeat.indexOf(e);return i!=-1&&this._repeat.splice(i,1),this._current==e&&(this._current=null),t}next(){return this._current=this._queue.get(),this._current}}class yt extends ce{add(e,t){return this._queue.add(e,0),super.add(e,t)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,0),super.next()}}class xt extends ce{add(e,t,i){return this._queue.add(e,i!==void 0?i:1/e.getSpeed()),super.add(e,t)}next(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}class bt extends ce{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(e,t,i){return this._queue.add(e,i||this._defaultDuration),super.add(e,t)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(e){return e==this._current&&(this._duration=this._defaultDuration),super.remove(e)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(e){return this._current&&(this._duration=e),this}}const Et={Simple:yt,Speed:xt,Action:bt};class ue{constructor(e,t={}){this._lightPasses=e,this._options=Object.assign({topology:8},t)}_getCircle(e,t,i){let s=[],n,l,a;switch(this._options.topology){case 4:l=1,a=[0,1],n=[T[8][7],T[8][1],T[8][3],T[8][5]];break;case 6:n=T[6],l=1,a=[-1,1];break;case 8:n=T[4],l=2,a=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let o=e+a[0]*i,c=t+a[1]*i;for(let u=0;u<n.length;u++)for(let f=0;f<i*l;f++)s.push([o,c]),o+=n[u][0],c+=n[u][1];return s}}class It extends ue{compute(e,t,i,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;let n=[],l,a,o,c,u;for(let f=1;f<=i;f++){let _=this._getCircle(e,t,f),d=360/_.length;for(let g=0;g<_.length;g++)if(o=_[g][0],c=_[g][1],l=d*(g-.5),a=l+d,u=!this._lightPasses(o,c),this._visibleCoords(Math.floor(l),Math.ceil(a),u,n)&&s(o,c,f,1),n.length==2&&n[0]==0&&n[1]==360)return}}_visibleCoords(e,t,i,s){if(e<0){let a=this._visibleCoords(0,t,i,s),o=this._visibleCoords(360+e,360,i,s);return a||o}let n=0;for(;n<s.length&&s[n]<e;)n++;if(n==s.length)return i&&s.push(e,t),!0;let l=0;if(n%2){for(;n<s.length&&s[n]<t;)n++,l++;return l==0?!1:(i&&(l%2?s.splice(n-l,l,t):s.splice(n-l,l)),!0)}else{for(;n<s.length&&s[n]<t;)n++,l++;return e==s[n-l]&&l==1?!1:(i&&(l%2?s.splice(n-l,l,e):s.splice(n-l,l,e,t)),!0)}}}class Lt extends ue{compute(e,t,i,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;let n=[],l,a,o,c,u,f;for(let _=1;_<=i;_++){let d=this._getCircle(e,t,_),g=d.length;for(let w=0;w<g;w++)if(l=d[w][0],a=d[w][1],c=[w?2*w-1:2*g-1,2*g],u=[2*w+1,2*g],o=!this._lightPasses(l,a),f=this._checkVisibility(c,u,o,n),f&&s(l,a,_,f),n.length==2&&n[0][0]==0&&n[1][0]==n[1][1])return}}_checkVisibility(e,t,i,s){if(e[0]>t[0]){let d=this._checkVisibility(e,[e[1],e[1]],i,s),g=this._checkVisibility([0,1],t,i,s);return(d+g)/2}let n=0,l=!1;for(;n<s.length;){let d=s[n],g=d[0]*e[1]-e[0]*d[1];if(g>=0){g==0&&!(n%2)&&(l=!0);break}n++}let a=s.length,o=!1;for(;a--;){let d=s[a],g=t[0]*d[1]-d[0]*t[1];if(g>=0){g==0&&a%2&&(o=!0);break}}let c=!0;if((n==a&&(l||o)||l&&o&&n+1==a&&a%2||n>a&&n%2)&&(c=!1),!c)return 0;let u,f=a-n+1;if(f%2)if(n%2){let d=s[n];u=(t[0]*d[1]-d[0]*t[1])/(d[1]*t[1]),i&&s.splice(n,f,t)}else{let d=s[a];u=(d[0]*e[1]-e[0]*d[1])/(e[1]*d[1]),i&&s.splice(n,f,e)}else if(n%2){let d=s[n],g=s[a];u=(g[0]*d[1]-d[0]*g[1])/(d[1]*g[1]),i&&s.splice(n,f)}else return i&&s.splice(n,f,e,t),1;let _=(t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]);return u/_}}const R=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];class Pe extends ue{compute(e,t,i,s){s(e,t,0,1);for(let n=0;n<R.length;n++)this._renderOctant(e,t,R[n],i,s)}compute180(e,t,i,s,n){n(e,t,0,1);let l=(s-1+8)%8,a=(s-2+8)%8,o=(s+1+8)%8;this._renderOctant(e,t,R[a],i,n),this._renderOctant(e,t,R[l],i,n),this._renderOctant(e,t,R[s],i,n),this._renderOctant(e,t,R[o],i,n)}compute90(e,t,i,s,n){n(e,t,0,1);let l=(s-1+8)%8;this._renderOctant(e,t,R[s],i,n),this._renderOctant(e,t,R[l],i,n)}_renderOctant(e,t,i,s,n){this._castVisibility(e,t,1,1,0,s+1,i[0],i[1],i[2],i[3],n)}_castVisibility(e,t,i,s,n,l,a,o,c,u,f){if(!(s<n))for(let _=i;_<=l;_++){let d=-_-1,g=-_,w=!1,b=0;for(;d<=0;){d+=1;let I=e+d*a+g*o,S=t+d*c+g*u,P=(d-.5)/(g+.5),X=(d+.5)/(g-.5);if(!(X>s)){if(P<n)break;if(d*d+g*g<l*l&&f(I,S,_,1),!w)!this._lightPasses(I,S)&&_<l&&(w=!0,this._castVisibility(e,t,_+1,s,P,l,a,o,c,u,f),b=X);else{if(!this._lightPasses(I,S)){b=X;continue}w=!1,s=b}}}if(w)break}}}const q={DiscreteShadowcasting:It,PreciseShadowcasting:Lt,RecursiveShadowcasting:Pe};class St{constructor(e){this._scheduler=e,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let e=this._scheduler.next();if(!e)return this.lock();let t=e.act();t&&t.then&&(this.lock(),t.then(this.unlock.bind(this)))}return this}}const y=it;class p{constructor(e=0,t=0){h(this,"x");h(this,"y");this.x=e,this.y=t}toString(){return this.x+","+this.y}is(e){return this.x==e.x&&this.y==e.y}dist8(e){let t=e.x-this.x,i=e.y-this.y;return Math.max(Math.abs(t),Math.abs(i))}dist4(e){let t=e.x-this.x,i=e.y-this.y;return Math.abs(t)+Math.abs(i)}dist(e){let t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}plus(e){return new p(this.x+e.x,this.y+e.y)}minus(e){return new p(this.x-e.x,this.y-e.y)}}class m{constructor(e,t={ch:"!",fg:"red"}){h(this,"_visual");h(this,"_xy");h(this,"_level");h(this,"visible",!0);h(this,"item",!1);h(this,"game");h(this,"name",null);this.game=e,this._visual=t}setVisual(e){this._visual={...this._visual,...e}}getVisual(){return this._visual}getXY(){return this._xy}getLevel(){return this._level}setPosition(e,t){return this._xy=e,t&&(this._level=t),this}remove(){var e;(e=this.getLevel())==null||e.removeSpecialEntity(this)}onInteract(e){return!0}}class L extends m{constructor(t,i,s=1){super(t,{ch:"+",fg:s===1?"yellow":"#d0d"});h(this,"level",1);h(this,"log");h(this,"discovered",!1);h(this,"onDiscover");this.level=s,this.visible=!1,this.log=i.text,this.onDiscover=i.onDiscover}onInteract(t){return this.getLevel().textBuffer.displayBox(this.log,()=>{this.discovered||this.onDiscover(this),this.discovered=!0;let i=this.level===1?"#aa0":"#838";this.setVisual({ch:"+",fg:i}),this.getLevel().draw(this.getXY())}),!1}}const Vt={text:`
%c{#098}
::RECOVERED LOGS::  

::MISSION OBJECTIVE::

Distress signal detected from deep-space research vessel INTREPID (DSRV-890).

Primary objective: Locate and recover INTREPID vessel and crew.  
---
%c{#098}
::PERSONNEL MANIFEST::  

- Commanding Officer Lo  
- Science Officer Balthar  
- Engineering Officer Dax  
- Security Officer Hanes (reassignment)
- Security Officer Argos  
---
%c{#098}
::CRITICAL MISSION LOGS::  

...
5671008 - Atmospheric entry initiated; ALERT: velocity exceeds safe parameters.  
5671147 - INTREPID emergency beacon detected.
5671203 - Cryosleep pods A, D, E activated.
5672724 - Shuttle undocking process initiated.
5679007 - Emergency cryospleep pod activation sequence initiated.
5679114 - Cryosleep pod C: activated.
5684026 - Cryosleep pod B: activated.  


::END LOGS::
`.trim(),onDiscover:r=>null},Tt={text:`
%c{#098}
::SCIENCE OFFICER BALTHAR LOG BEACON::

Something went wrong. I awoke but Lo and the sec goons were gone.  Why wouldn't they wake us?
---
%c{#098}
Dax is still out. I debated waking him, but there's too many unknowns, I determined it would be safer to locate the others and scan for dangers first.
---
%c{#098}
I'm detecting unusually strong energy signatures near by. I will attempt to investigate.
`.trim(),onDiscover:r=>null},Ot={text:`
%c{#098}
:COMMANDING OFFICER LO TRANSMISSION::

The Intrepid's on the other side of this river. Hanes, set up the energy bridge, let's get this over with.
---
%c{#098}
Dammit, my torchlamp fell off somewhere. Never mind, we'll get it on the way back.
`.trim(),onDiscover:r=>null},Kt={text:`
%c{#098}
::COMMANDING OFFICER LO TRANSMISSION::

Argos, take EV2 and explore the area, make sure we're alone. Keep me posted. We'll rendezvous back at the ship and awake the others.'
---
%c{#098}
Hanes, you're with me.
`.trim(),onDiscover:r=>null},Pt={text:`
%c{#098}
::COMMANDING OFFICER LO TRANSMISSION::

Argos, report, where the hell are you?
`.trim(),onDiscover:r=>null},Rt={text:`
%c{#098}
::SECURITY OFFICER ARGOS TRANSMISSION::

There's definitely something up here, but it's slow going. The ground is unstable.
`.trim(),onDiscover:r=>null},kt={text:`
I picked up a decaying log signal. This one happened a while ago.
---
%c{#b80}
::WARNING BEACON::

We came in search of efficient power. What we found was beyond imagination.
---
%c{#b80}
The power of these crystals is too great. Humanity cannot be trusted.
---
%c{#b80}
On behalf of the Let Stars Be activist group, I Yorq, now commit this research back to the stars. Goodbye all.
`.trim(),onDiscover:r=>null},Ct={text:`
%c{#b80}
::LOW POWER SUBSPACE TRANSMISSION::

This is Hanes. I got the data. I am en route now via class M2 shuttle to the agreed coordinates. Be ready.
`.trim(),onDiscover:r=>null},At={text:`
I picked up a decaying log signal. This one happened a while ago.
---
%c{#b80}
::INTREPID RESEARCH CHANNEL BROADCAST::

I'm exploring further down the range. The crystals here are even denser. I can't wait to bring these new readings back to the lab.
`.trim(),onDiscover:r=>null},Mt={text:`
I picked up a decaying log signal. This one happened a while ago.
---
%c{#b80}
::DISTRESS SIGNAL::

This is Science Officer Jessup of the INTREPID DSRV-890. There's been an accident.
---
%c{#b80}
Our ship is destroyed, one member of the crew is dead. We are stranded.
---
%c{#b80}
We're stranded at the edge of known space. Requesting assistance.
---
%c{#b80}
Requesting rescue...
---
%c{#b80}
Who am I kidding. We won't survive until rescue arrives, even from the fastest ship.
---
%c{#b80}
Requesting recovery.
---
%c{#b80}
Jessup out.
`.trim(),onDiscover:r=>null},W=class W extends m{constructor(e){super(e,{ch:"=",fg:"#950"})}onInteract(e){return this.getLevel().textBuffer.write(W.msg),!1}};h(W,"msg","This is solid cliff face.  I can't pass.");let C=W;const Re="&";class re extends m{constructor(t){super(t,{ch:Re,fg:"yellow"});h(this,"concious",!0);h(this,"visible",!1);h(this,"name","Commander Lo")}onInteract(t){return this.concious?(this.getLevel().loDiscovered=!0,this.getLevel().textBuffer.displayBox(Bt,()=>!0),this.concious=!1):t===this.getLevel().ev?t.load(this):t===this.getLevel().player&&this.getLevel().textBuffer.write("I have to get him back to the ship, but he's too heavy for me to carry."),!1}}const Bt=`
It's Commander Lo! He's been shot. He's barely conscious, but he is alive.
---
"Dax... I'm glad to see you. Where is Balthar and Argos? Never mind, I need you to listen carefully."
---
"This was more than a salvage mission. The Intrepid crew were working on classified research and I was under confidential orders to retrieve it. Per security clearance protocols, I couldn't wake you until assessing the situation."
---
"It doesn't matter now. Hanes turned on us. When we recovered whatever research we could find, he shot me, took the EV, and stole the research. I heard our shuttle launch, so he's most likely well into unknown space by now."
---
"That information in the wrong hands is bad news. We need to get back home and warn command."
---
"At least one thing went our way -- I found something in this grove. A chunk of these crystals. We can bring that back. Dax..."
---
He slumps over.
---
...
---
He's unconscious. I have to get him back to the ship's med bay.
---
Hang in there Commander.
`;class U extends m{constructor(t){super(t,{ch:"O",fg:"white"});h(this,"visible",!1);h(this,"remote",null);h(this,"direction",0);h(this,"_loaded",null);h(this,"_keys");this._keys={},this._keys[v.VK_UP]=0,this._keys[v.VK_W]=0,this._keys[v.VK_K]=0,this._keys[v.VK_RIGHT]=1,this._keys[v.VK_D]=1,this._keys[v.VK_L]=1,this._keys[v.VK_DOWN]=2,this._keys[v.VK_S]=2,this._keys[v.VK_J]=2,this._keys[v.VK_LEFT]=3,this._keys[v.VK_H]=3,this._keys[v.VK_A]=3}getVisual(){return{ch:this._loaded?"Θ":"O",fg:this.inRange()?"yellow":"white"}}onInteract(t){return this.getLevel().battery===0?(this.getLevel().textBuffer.write("There's no power to run it."),!1):this.carryingLo()?(this.getLevel().textBuffer.write("Commander Lo is in the EV. I don't want to move him unnecessarily."),!1):this.load(t)}inRange(){var t;return this.playerIsRiding()||this.getLevel().activeItem===k&&((t=this.remote)==null?void 0:t.isInRange(this.getXY()))}isLoaded(){return!!this._loaded}playerIsRiding(){return this._loaded===this.getLevel().player}carryingLo(){return this._loaded instanceof re}load(t){var i;if(this._loaded)return this.getLevel().textBuffer.write(`The EV is already loaded. Press %c{${M}}[${k}]%c{} to unload it first.`),!1;if(t===this.getLevel().player)return(i=this.remote)!=null&&i.active?(this.getLevel().textBuffer.write("If I turn off the remote I can board the EV for manual control."),!1):(this._loaded=t,t.visible=!1,this.getLevel().activeItem&&this.getLevel().deactivateItem(this.getLevel().activeItem),this.getLevel().textBuffer.write(`Let's roll. Press %c{${M}}[${k}]%c{} to exit.`),!0);{this._loaded=t,this.getLevel().removeSpecialEntity(t);let n=`${t.name||"The item"} has been loaded into the EV. Press %c{${M}}[${k}]%c{} to unload.`;return t instanceof re&&(n="Commander Lo is safely inside the EV. Now to get him to the ship."),this.getLevel().textBuffer.write(n),!0}}unload(){let t=T[4].find(([i,s])=>{var a;let n=this.getLevel().getEntityAt(this.getXY().plus(new p(i,s)));return!n||((a=this.getLevel().player.getXY())==null?void 0:a.toString())===n.getXY().toString()?!1:(this.playerIsRiding()?".":"^.").includes((n==null?void 0:n.getVisual().ch)||"XXX")});if(t){let i=this.getXY().plus(new p(...t));return this.playerIsRiding()?(this.getLevel().player.visible=!0,this.getLevel().player.setPosition(i)):this.getLevel().setSpecialEntity(this._loaded,i),this._loaded=null,this.getLevel().draw(i),this.getLevel().draw(this.getXY()),!0}else{let i=this.playerIsRiding()?"I can't safely get out of the EV here.":"There's no place to unload the EV here.";return this.getLevel().textBuffer.write(i),!1}}_handleKey(t){var o,c;if(!(t in this._keys))return!1;let i=this._keys[t];this.direction=i*2;let s=T[4][i],n=this.getXY().plus(new p(s[0],s[1])),l=this.getLevel().getEntityAt(n);return n.toString()===((o=this.getLevel().player.getXY())==null?void 0:o.toString())?this.load(this.getLevel().player):l?this.inRange()?!this.playerIsRiding()&&!((c=this.remote)!=null&&c.isInRange(n))?(this.getLevel().textBuffer.write("I can't go that way, it's out of range."),!1):(l.onInteract(this)&&this.moveTo(n),this.getLevel().textBuffer.showing||this.getLevel().updateFOV(),!0):(this.getLevel().textBuffer.write("The EV is out of range."),!1):(this.getLevel().textBuffer.write("I can't pilot the EV into an unknown space."),!1)}moveTo(t){let i=this.getXY();this.setPosition(t),this.playerIsRiding()&&this.getLevel().player.setPosition(t);let s=this.getLevel().getEntityAt(i,!1,!0);s&&(s.visible=!0),this.getLevel().draw(i),this.getLevel().draw(t)}}const fe="X";class j extends m{constructor(t,i){super(t,{ch:fe,fg:"white"});h(this,"message");this.visible=!1,this.message=i}onInteract(t){return this.getLevel().textBuffer.displayBox(this.message,()=>!0),!1}}const Nt=`
It's Dr. Balthar. She's dead.
---
The cause is unclear. If I had to guess, I'd say it happened fairly recently.

---
%c{#098}
::SCIENCE OFFICER BALTHAR PERSONAL LOGS::

These crystal formations are incredible! I've never seen anything like it. They seem to resonate with energy patterns beyond my scanner's operational range. This discovery could fundamentally change the limits of our technology as we know it.

I'm going to try to extract a sample...

::LOGS CORRUPTED::
`.trim(),Dt=`
Oh no, it's Argos, the security officer. He's crushed under a giant boulder. It looks like he got caught in a rockslide.
`.trim(),Ft=`
I found one of the crew of the Intrepid. She's been dead for a long time.

---
%c{#098}
::PERSONAL LOGS::

We're out of food.
---
%c{#098}
We're out of power. 
---
%c{#098}
We're out of luck.
`.trim(),zt=`
Another Intrepid crew member, also long dead.

---
%c{#098}
::PERSONAL LOGS::

I still can't believe what happened. Yorq knew how volatile the crystals are, he would have known to be cautious. For such a large explosion to happen, he must have been extremely careless. All our research, gone. We'll be gone soon too now.
`.trim(),k="5",M="#d00";class ke{constructor(e){h(this,"key",k);h(this,"name","EV2 remote");h(this,"color",M);h(this,"active",!1);h(this,"_fov");h(this,"_level");h(this,"_r",4);h(this,"_fovCells",[]);h(this,"_FOVLightPasses",(e,t)=>!0);h(this,"_FOVIlluminate",(e,t,i,s)=>{let n=new p(e,t),l=this._level.getEntityAt(n);if(!l)return;this._fovCells.push(n.toString());let{ch:a}=l.getVisual(),o="red";".^".includes(l.getVisual().ch)&&(o="darkred"),(Re+fe+"{o+?").includes(l.getVisual().ch)&&(o="yellow"),l instanceof U&&(o=l.getVisual().fg),this._level.game.display.draw(e,t,a,o)});this._level=e,this.setPower(),this._fov=new q.RecursiveShadowcasting(this._FOVLightPasses,{topology:8})}setPower(){this._r={1:4,2:8,3:12,4:13}[this._level.powerLevel]||4}getFOV(){return{r:this._r,fov:this._fov,cb:this._FOVIlluminate}}isInRange(e){return this._fovCells.includes(e.toString())}onActivate(){let e=this._level.ev;if(!e.isLoaded())return this._fovCells=[],this._fovCells.push(this._level.player.getXY().toString()),this.active=!0,!0;if(e.carryingLo())return!0;if(!e.playerIsRiding())throw"unexpected onActivate while ev was loaded with non-player";return e.unload(),this._level.updateFOV(),!1}onDeactivate(){let e=this._level.ev;if(!e.isLoaded()||e.carryingLo())return this._fovCells=[],this.active=!1,!0;if(e.playerIsRiding())throw"unexpected onDeactivate while ev was loaded with player";return e.unload(),this._level.updateFOV(),!1}}class Ut extends m{constructor(t){super(t,{ch:"@",fg:"yellow"});h(this,"_keys");h(this,"ready");this.ready=!0,this._keys={},this._keys[v.VK_UP]=0,this._keys[v.VK_W]=0,this._keys[v.VK_K]=0,this._keys[v.VK_RIGHT]=1,this._keys[v.VK_D]=1,this._keys[v.VK_L]=1,this._keys[v.VK_DOWN]=2,this._keys[v.VK_S]=2,this._keys[v.VK_J]=2,this._keys[v.VK_LEFT]=3,this._keys[v.VK_H]=3,this._keys[v.VK_A]=3,this._keys[v.VK_ENTER]=-1}getSpeed(){return 1}act(){this.getLevel().textBuffer.flush(),this.game.engine.lock(),this.ready=!0}onKeyDown(t){if(!this.ready)return;(this.getLevel().activeItem===k||this.getLevel().ev.playerIsRiding()?this.getLevel().ev:this)._handleKey(t.keyCode)&&(this.ready=!1,this.game.engine.unlock())}_handleKey(t){if(!(t in this._keys))return!1;let i=this._keys[t];if(i==-1)return!0;let s=T[4][i],n=this.getXY().plus(new p(s[0],s[1])),l=this.getLevel().getEntityAt(n,!1,!0),a=this.getLevel().getEntityAt(n,!0,!1);if(!l&&!a)return!1;let o="",c=!1;return l&&!l.visible&&(l.visible=!0,o="I'm exploring into the unknown. "),a&&!a.visible&&!(a instanceof L)&&(a.visible=!0,o="I found something.",c=!0),a instanceof C&&(o=C.msg),this.getLevel().textBuffer.write(o),this.getLevel().draw(n),c||(this.getLevel().getEntityAt(n).onInteract(this)&&this.moveTo(n),this.getLevel().textBuffer.showing||this.getLevel().updateFOV()),!0}moveTo(t){let i=this.getXY();this.setPosition(t),this.getLevel().draw(i),this.getLevel().draw(t)}}class Xt{constructor(e){h(this,"showing");h(this,"_data");h(this,"_multiText");h(this,"displayBoxPos");h(this,"displayBoxSize");h(this,"_options");h(this,"_cb");h(this,"game");this.showing=!1,this._data=[],this._options={display:e.display,position:new p,size:new p},this.displayBoxPos=new p(10,5),this.displayBoxSize=new p(90,25),this._cb=null,this.game=e}configure(e){Object.assign(this._options,e)}clear(){this._data=[]}write(e,t=!1){!t&&this.clear(),this._data.push(e),!t&&this.flush()}flush(){let e=this._options,t=e.display,i=e.position,s=e.size;for(let l=0;l<s.x;l++)for(let a=0;a<s.y;a++)t.draw(i.x+l,i.y+a);let n=this._data.join(" ");t.drawText(i.x,i.y,n,s.x)}displayBox(e,t=null){this._multiText=e.split("---"),this._cb=t,this._renderDisplayBox(this._multiText.shift())}_renderDisplayBox(e){this.showing=!0;let i=this._options.display,s=this.displayBoxPos,n=this.displayBoxSize;for(let c=0;c<n.x;c++)for(let u=0;u<n.y;u++)if(c===0||c===n.x-1||u===0||u===n.y-1){let f=c===0||c===n.x-1?"+":"=";i.draw(s.x+c,s.y+u,f)}else i.draw(s.x+c,s.y+u," ");let l=5,a=s.x+l,o=s.y+l;i.drawText(a,o,e,n.x-l*2),i.drawText(a,s.y+n.y-3,"Press [Enter] to continue",n.x-l*2)}clearDisplayBox(){this.showing=!1;let t=this._options.display,i=this.displayBoxPos,s=this.displayBoxSize,n=new p;for(let a=0;a<s.x;a++)for(let o=0;o<s.y;o++)n.x=i.x+a,n.y=i.y+o,t.draw(n.x,n.y," "),this.game.level.draw(n);let l=this._multiText.shift();if(l){this._renderDisplayBox(l);return}this._cb&&(this._cb(),this._cb=null),this.game.level.updateFOV()}}const Yt=`                                                                                                              
                                                                                                        *     
                                                                          . }                                 
                                                                       .                                      
                *                               *                   .                                         
                                                                .                                             
                                                                                                              
                                                            .                                                 
                                                                                                              
                                                                                  *                           
                                                       .                                                      
                                                                                                              
                                                                                                              
                                                  .                                                           
                                                                                                              
                                                                                                              
                   *                         .                                                                
                                                                                                              
                     *                                                                *                       
                                         .                                                                    
     *                                                      *                                                 
                                                                                                              
                                                                                                              
                                                                                                              
                                   .                                                                          
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
         ##                  .                                                                                
###     ##### ##                                                                                              
#####  ###########                ###                                       /                    /            
###################///         #########/##                                 ////               ///            
################################################   ##################   ######///////#######/////////####///  
################################################~~~############################//////########///////##########
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
`;class $t{constructor(e){h(this,"size",new p(110,40));h(this,"game");h(this,"_levelData",Yt);h(this,"_state",1);h(this,"_interval");this.game=e,this._generateMap(),this._state++}draw(e){this._generateMap()}updateFOV(){}onKeyDown(e){e.key==="Enter"&&(this._state<7&&(clearInterval(this._interval),this._generateMap()),this._state++)}getSize(){return this.size}_clear(){for(let e=0;e<this.size.y;e++)for(let t=0;t<this.size.x;t++)this.game.display.draw(t,e," ",null,null)}_generateMap(){let e=[],t=this._levelData.split(`
`);for(let n=0;n<this.size.y;n++)for(let l=0;l<this.size.x;l++){let a=t[n][l];if(a==="*"&&e.push([l,n]),a==="."||a==="}"){this.game.display.draw(l,n," ");continue}this.game.display.drawText(42,38,"%c{#ff0}Thank you for playing!");let o=a==="#"?"#950":a==="."?"orange":a==="~"?"red":"white";a==="/"&&(a=V.getUniform()>.5?"/":"\\",o=V.getUniform()>.5?"#a0e":"#0ae"),this.game.display.draw(l,n,a,o)}let i=this.size.y-5,s=setInterval(()=>{for(let n=0;n<this.size.x;n++){let l=t[i][n];if(".}".includes(l)){let a=l==="."?"orange":"white";this.game.display.draw(n,i,l,a)}}i--,i===0&&clearInterval(s)},70);setInterval(()=>{let n=V.getItem(e),l=V.getItem(["#aaa","white"]);this.game.display.draw(n[0],n[1],"*",l)},50)}}let _e=0;class Ce extends m{constructor(e){super(e,{ch:"{",fg:"white"})}onInteract(e){if(e instanceof U){if(e.carryingLo()){this.getLevel().ev._loaded=null,e.remove(),this.getLevel().textBuffer.write("Lo is safely loaded back on the ship. We're ready to go home!");let t=this.getLevel().activeItem;return this.getLevel().deactivateItem(t),delete this.getLevel()._inventory[t],this.getLevel()._drawInventory(),this.getLevel().ev.remote.active=!1,this.getLevel().loOnShip=!0,!1}return this.getLevel().textBuffer.write("I'm not ready to dock the EV yet."),!1}return this.getLevel().loDiscovered&&!this.getLevel().loOnShip?(this.getLevel().textBuffer.write("I won't leave until I get Commander Lo back on board."),!1):this.getLevel().loDiscovered&&this.getLevel().loOnShip?(this.getLevel().textBuffer.displayBox(`
Lo is healing in the med bay. All systems ready. Let's go home!
---
These crystals are doing something to the engines I've never seen before. The readout says it will only take a 2 months to get back.
---
I think this time I'll stay awake.
`.trim(),()=>{this.game.switchLevel(new $t(this.game))}),!1):_e===0?(this.getLevel().textBuffer.displayBox(`
The ship appears to be fully functional. But our shuttle is missing. What happened while I was out?
`.trim()),_e++,!1):(this.getLevel().textBuffer.write("I can't go anywhere without finding the rest of the crew."),!1)}}let pe=0;class Ht extends m{constructor(e){super(e,{ch:"o",fg:"white"})}onInteract(e){return pe===0?this.getLevel().textBuffer.displayBox(`
I found ship wreckage...
---
It's the Interpid!
`.trim()):this.getLevel().textBuffer.write("The Intrepid is destroyed beyond repair."),pe++,!1}}class Gt extends m{constructor(e){super(e,{ch:"?",fg:"violet"})}onInteract(e){return this.getLevel().textBuffer.displayBox(`
I found a spare power cell. It's not full, but it still has plenty juice left.
`.trim(),()=>{this.getLevel().battery=3,this.getLevel().drawPower(),this.remove()}),!1}}class de extends m{constructor(t,i=!1){super(t,{ch:i?"~":" ",fg:"red"});h(this,"river");this.visible=!1,this.river=i}onInteract(t){if(this.getLevel().getEntityAt(this.getLevel().player.getXY())instanceof O)this.getLevel().textBuffer.write("Careful!");else{let s=this.river?"A deep crimson river cuts across the ground here. I'll need to find some other way across.":"The ground splits into a bottomless chasm, I cannot pass.";this.getLevel().textBuffer.write(s)}return!1}}const Ae="4";class Wt{constructor(e){h(this,"key",Ae);h(this,"name","Bridge");h(this,"color","gray");h(this,"active",!1);h(this,"_level");h(this,"_deployed",!1);h(this,"_maxLength",2);h(this,"_timeoutId",null);h(this,"_deploySpeed");this._level=e,this.setPower(),this._deploySpeed=300}getFOV(){return null}setPower(){this._maxLength=this._level.powerLevel>1?6:2}_getChasmSize(e){let t=0,i=this._level.getEntityAt(this._level.player.getXY().plus(e));for(;i&&i instanceof de;)t++,i=this._level.getEntityAt(i.getXY().plus(e));return t===0?0:!i||i.getVisual().ch!=="."?999:t}_deploy(e){let t=(i,s)=>{var l;let n=((l=this._level.getEntityAt(s))==null?void 0:l.getVisual().ch)===".";if(this._level.setSpecialEntity(new O(this._level.game,{suspended:!n}),s),n){this._timeoutId=null;return}this._timeoutId=setTimeout(()=>t(i+1,s.plus(e)),this._deploySpeed)};this._level.setSpecialEntity(new O(this._level.game,{suspended:!1}),this._level.player.getXY()),t(1,this._level.player.getXY().plus(e))}_retract(){let e=this._level.player.getXY(),i=this._level.getEntityAt(e.plus(new p(1,0)))instanceof O?new p(1,0):new p(-1,0),s=[this._level.getEntityAt(e)],n=this._level.getEntityAt(e.plus(i));for(;n instanceof O;)s.push(n),n=this._level.getEntityAt(n.getXY().plus(i));let l=()=>{this._level.removeSpecialEntity(s.pop()),s.length>0?this._timeoutId=setTimeout(l,this._deploySpeed):this._timeoutId=null};l()}onActivate(){var o;if(this._level.ev.playerIsRiding())return this._level.textBuffer.write("I have to get out of the EV to use the bridge."),!1;if((o=this._level.ev.remote)!=null&&o.active)return this._level.textBuffer.write("I can't use the bridge and pilot the EV at the same time."),!1;if(this._timeoutId)return!1;let e=this._level.player.getXY(),t=this._level.getEntityAt(e),i=new p(1,0),s=new p(-1,0),n=this._getChasmSize(i),l=this._getChasmSize(s),a="";return this._deployed?t instanceof O?t.suspended?a="I can't retract the bridge while I'm on the middle of it.":(this._retract(),this._deployed=!1):a="I need to retrieve the bridge if I want to use it again.":n||l?n==999||l==999?a="There's no safe space on the other side to anchor to.":n>this._maxLength||l>this._maxLength?a="The river here is too wide for the bridge.":(this._deploy(n?i:s),this._deployed=!0):a="No point using the bridge on solid ground.",a&&this._level.textBuffer.write(a),!1}onDeactivate(){return!1}}class O extends m{constructor(t,i){super(t,{ch:"?",fg:"gray"});h(this,"item");h(this,"deployed");h(this,"broken");h(this,"suspended");this.broken=!!i.broken,this.suspended=!!i.suspended,this.deployed=!i.asItem,this.item=!!i.asItem,this.visible=!this.item}getVisual(){return this.item?{ch:"?",fg:"gray"}:{ch:"I",fg:"#aaa"}}onInteract(t){return this.broken?(this.getLevel().textBuffer.write("An energy bridge was set up across the river. However, it isn't working, maybe the power is drained."),!1):this.deployed?!0:(this.getLevel().textBuffer.displayBox(`I now have a deployable energy bridge. Press %c{gray}[${Ae}]%c{} near a river to deploy or retract it.`,()=>{this.remove();const i=new Wt(this.getLevel());this.getLevel().addInventory(i)}),!1)}}const Me="∆";class J extends m{constructor(t){super(t,{ch:Me,fg:"purple"});h(this,"visible",!1);h(this,"intervalId",-1);this.intervalId=setInterval(()=>{let i=V.getUniform()*150+10,s=V.getItem(["darkgray","blue"]),n=y.add(y.fromString(s),[i,i,i]);this.setVisual({fg:y.toRGB(n)}),this.getLevel().draw(this.getXY())},100)}onInteract(t){return this.getXY(),this.getLevel().textBuffer.displayBox("A crystal shard! I can feel it buzzing with energy. My equipment seems to respond as well...",()=>{this.remove(),clearInterval(this.intervalId),this.getLevel().powerLevel++,this.getLevel().battery=5,this.getLevel().drawPower(),this.getLevel().drawNewShard(),this.getLevel().updateFOV()}),!1}}const Be="2";class qt{constructor(e){h(this,"key",Be);h(this,"name","Torch");h(this,"color","orange");h(this,"active",!1);h(this,"r",5);h(this,"_fov");h(this,"_level");h(this,"_FOVLightPasses",(e,t)=>{let i=this._level.getEntityAt(new p(e,t),!0,!0);if(!i||i instanceof Ce)return!1;if(i instanceof O||i instanceof J)return!0;if(i instanceof K){if(i.visible=!0,i.dense)return i.clearing?this._level.powerLevel>3:!1;{let s=this._level.player.getXY().dist8(new p(e,t));return this._level.powerLevel>1&&s<3?!0:i.clearing}}return this._level.isSpecial(i)&&!(i instanceof L)?(i.visible=!0,!1):!"=o".includes(i.getVisual().ch)});h(this,"_FOVIlluminate",(e,t,i,s)=>{let n=new p(e,t),l=this._level.getEntityAt(n,!0,!0);if(l&&l instanceof L&&(l=this._level.getEntityAt(n,!1,!0)),!!l&&!(l instanceof K&&l.dense&&this._level.powerLevel===1))if(l.visible=!0,l instanceof K&&l.clearing){let a=this._level.powerLevel,o=y.toHex([30*a,30*a,255]),c=Math.min(170,Math.round(255*Math.pow(5/i,1)/5)),u=y.add(y.fromString(o),[c,c,Math.floor(c/2)]);this._level.game.display.draw(e,t,".",y.toHex(u))}else{let{ch:a,fg:o}=l.getVisual(),c=Math.min(170,Math.round(255*Math.pow(5/i,1)/5));c+=10*(this._level.powerLevel-1);let u=y.add(y.fromString(o),[c,c,Math.floor(c/2)]);this._level.game.display.draw(e,t,a,y.toHex(u))}});this._level=e,this.setPower(),this._fov=new q.RecursiveShadowcasting(this._FOVLightPasses,{topology:8})}setPower(){this.r={1:5,2:8,3:10,4:20}[this._level.powerLevel]||5}getFOV(){return{r:this.r,fov:this._fov,cb:this._FOVIlluminate}}onActivate(){return this.active=!0,!0}onDeactivate(){return this.active=!1,!0}}class K extends m{constructor(t,i=!1,s=!1){let n=V.getUniform()>.5?"/":"\\";s&&(n="|");let l=V.getUniform()>.5?"#a0e":"#0ae";super(t,{ch:n,fg:l});h(this,"clearing");h(this,"dense");this.clearing=i,this.dense=s}onInteract(t){const i=this.getLevel().activeItem===Be;if(this.getLevel().ev.playerIsRiding())return this.getLevel().textBuffer.write("These crystals are so dense, I can't get through on the EV."),!1;let s="These crystal formations are even denser, it's impossible to pass through without more light.";if(this.dense&&this.getLevel().powerLevel===1)return this.getLevel().textBuffer.write(s),!1;if(i)this.clearing||this.getLevel().textBuffer.write("Solid crystals block the path.");else{let n=this.dense?s:"Giant crystal formations grow like a dense forest, blocking out the light. It's impossible to safely pass through them.";this.getLevel().textBuffer.write(n)}return this.clearing&&i}}const ve="1";class jt{constructor(e){h(this,"key",ve);h(this,"name","Terminal");h(this,"color","green");h(this,"active",!1);h(this,"_logs",[]);h(this,"_level");h(this,"_fov");h(this,"_r",1);h(this,"_intervalID");h(this,"_initR",1);h(this,"_FOVGrawRate",1);h(this,"_FOVMaxRadius",10);h(this,"_FOVSpeed",30);h(this,"_FOVWidth",2);h(this,"_FOVLightPasses",(e,t)=>!0);h(this,"_FOVIlluminate",(e,t,i,s)=>{let n=new p(e,t),l=this._level.getEntityAt(n,!0,!0),a=this._level.powerLevel>1?"#808":"#880";if(l)if(this._r-i<this._FOVWidth)if(l instanceof L&&l.level<=this._level.powerLevel)l.visible=!0;else{let o=190*this._FOVMaxRadius/i,c=y.multiply(y.fromString(a),[o,o,o]);this._level.game.display.draw(e,t,"+",y.toHex(c))}else this._level.draw(n)});this._level=e,this.setPower(),this._fov=new q.DiscreteShadowcasting(this._FOVLightPasses,{topology:4})}static getKey(){return ve}setPower(){this._FOVMaxRadius={1:10,2:18,3:24,4:38}[this._level.powerLevel]||10}getFOV(){return{r:this._r||1,fov:this._fov,cb:this._FOVIlluminate}}readLog(e){this._logs.push(e),this._level.textBuffer.displayBox(e)}onActivate(){return this.active=!0,this._r=this._initR,this._intervalID=setInterval(()=>{this._r+=this._FOVGrawRate,this._r>=this._FOVMaxRadius&&this._level.deactivateItem(this.key),this._level.updateFOV()},this._FOVSpeed),!0}onDeactivate(){return clearInterval(this._intervalID),this.active=!1,!0}}class Jt extends m{constructor(t){super(t,{ch:"?",fg:"green"});h(this,"item",!0)}onInteract(t){let i=t.getLevel();return i.textBuffer.displayBox("I found a terminal reader. It is now in my inventory. Press %c{green}[1]%c{} to activate or deactivate it. When activated, it can reveal hidden logs (%c{yellow}+%c{}) near me.",()=>{this.remove();const s=new jt(this.getLevel());i.addInventory(s)}),!1}}class Ne extends C{constructor(t){super(t);h(this,"scanned",!1);this.visible=!1}getVisual(){return{ch:this.scanned?"≠":"=",fg:"#950"}}onInteract(t){return this.scanned?(this.getLevel().textBuffer.write("There's a crack in the rock face here... I can push through."),this.remove(),!1):super.onInteract(t)}}class De extends m{constructor(e){super(e,{ch:"^",fg:"#540"})}onInteract(e){return e instanceof U?!0:(this.getLevel().textBuffer.write("The ground here is rocky and steep, I can't proceed by foot."),!1)}}class Qt extends m{constructor(t){super(t,{ch:"?",fg:"orange"});h(this,"item",!0);this.visible=!1}onInteract(t){let i=t.getLevel();return i.textBuffer.displayBox("I found a torch. Plus it has a little extra power in the cell. Press %c{orange}[2]%c{} to activate or deactivate it.",()=>{this.remove();const s=new qt(this.getLevel());i.addInventory(s),i.battery=4,i.drawPower()}),!1}}class Fe extends C{constructor(t){super(t);h(this,"scanned",!1);this.visible=!1}getVisual(){return{ch:this.scanned?"-":"=",fg:"#950"}}onInteract(t){return this.scanned?this.getLevel().ev.playerIsRiding()?(this.getLevel().textBuffer.write("There's something here, but I have to get out of the EV to check it out."),!1):(this.getLevel().textBuffer.write("There's a narrow passage in the cliffs here."),this.remove(),!0):super.onInteract(t)}}class ze extends m{constructor(t){super(t,{ch:"#",fg:"#962"});h(this,"name","The boulder");this.visible=!1}onInteract(t){return t===this.getLevel().player?this.getLevel().textBuffer.write("This is a large boulder, I can't move it."):t===this.getLevel().ev&&t.load(this),!1}}class Zt{constructor(e){h(this,"key","3");h(this,"name","Scanner");h(this,"color","#55f");h(this,"active",!1);h(this,"_initialR",1);h(this,"_r",1);h(this,"_intervalID",-1);h(this,"_fov");h(this,"_level");h(this,"_maxR",7);h(this,"_FOVLightPasses",(e,t)=>!0);h(this,"_FOVIlluminate",(e,t,i,s)=>{let n=new p(e,t),l=this._level.getEntityAt(n,!0,!1),a=this._level.getEntityAt(n,!1,!0),o=y.fromString("cyan");if(l&&l instanceof Ne){l.scanned=!0;return}if(l&&l instanceof Fe&&this._level.powerLevel>1){l.scanned=!0;return}if(l&&(l.item||(fe+"{o").includes(l.getVisual().ch))){l.visible=!0,this._level.draw(l.getXY());return}if(l&&l instanceof ze){let{ch:f}=l.getVisual();l.visible=!0,o=y.multiply(o,[150,150,150]),this._level.game.display.draw(e,t,f,y.toHex(o));return}let c=l&&l instanceof J;if(!c&&l&&this._level.isSpecial(l)&&!(l instanceof L)||!a)return;let{ch:u}=a.getVisual();if("^.".includes(u)&&!c)a.visible=!0,o=y.multiply(o,[150,150,150]),this._level.game.display.draw(e,t,u,y.toHex(o));else if(a instanceof K||c){let f=c?Me:u,_=y.randomize([100,100,100],100);a.clearing&&(o=[50,50,50]),o=y.add(o,_),this._level.game.display.draw(e,t,f,y.toHex(o))}});this._level=e,this.setPower(),this._fov=new q.RecursiveShadowcasting(this._FOVLightPasses,{topology:8})}setPower(){this._maxR={1:7,2:15,3:20,4:30}[this._level.powerLevel]||7}getFOV(){return{r:this._r,fov:this._fov,cb:this._FOVIlluminate}}onActivate(){return this.active=!0,this._intervalID=setInterval(()=>{this._r+=1,this._r>=this._maxR&&this._level.deactivateItem(this.key),this._level.updateFOV()},70),!0}onDeactivate(){return clearInterval(this._intervalID),this._r=this._initialR,this.active=!1,!0}}class ei extends m{constructor(t){super(t,{ch:"?",fg:"#55f"});h(this,"item",!0);this.visible=!1}onInteract(t){let i=t.getLevel();return i.textBuffer.displayBox("This is Dr. Balthar's scanner. Press %c{#55f}[3]%c{} to activate it.",()=>{this.remove();const s=new Zt(this.getLevel());i.addInventory(s)}),!1}}class ti extends m{constructor(t){super(t,{ch:"?",fg:M});h(this,"item",!0);this.visible=!1}onInteract(t){let i=t.getLevel();return i.textBuffer.displayBox(`This looks like a remote for Electric Vehicle 2. Press %c{${M}}[${k}]%c{} to activate it.`,()=>{this.remove();const s=new ke(this.getLevel());i.addInventory(s),i.ev.visible=!0,i.draw(i.ev.getXY())}),!1}}const me=new Set;class Q extends m{constructor(t,i){super(t,{ch:".",fg:"#430"});h(this,"id");this.id=i}onInteract(t){if(!me.has(this.id)){if(me.add(this.id),this.getLevel().battery--,this.getLevel().drawPower(),this.getLevel().battery===2)return this.getLevel().textBuffer.displayBox("My power cell is getting pretty low, I'll have to keep an eye on that."),!1;if(this.getLevel().battery===0){if(!this.getLevel().ev.playerIsRiding)throw"Unexpected full power drain";return this.getLevel().textBuffer.displayBox("I ran out of power! Guess it's back to going on foot again.",()=>{if(!this.getLevel().ev.unload())throw"Failed to unload EV on power drain";this.getLevel().deactivateItem(this.getLevel().activeItem)}),!1}}return!0}}const ne="#430",x=new Map;x.set("p",r=>new Gt(r));x.set("t",r=>new Jt(r));x.set("f",r=>new Qt(r));x.set("b",r=>new O(r,{asItem:!0}));x.set("X",r=>new j(r,Ft));x.set("Y",r=>new j(r,zt));x.set("L",r=>new re(r));x.set("r",r=>new ti(r));x.set("1",r=>new L(r,Vt));x.set("2",r=>new L(r,Tt));x.set("3",r=>new L(r,Ot));x.set("4",r=>new L(r,Kt));x.set("7",r=>new L(r,kt,2));x.set("8",r=>new L(r,At,2));x.set("9",r=>new L(r,Ct,2));x.set("0",r=>new L(r,Mt,2));x.set("%",r=>new Ne(r));x.set("$",r=>new Fe(r));x.set("*",r=>new J(r));const G=new Map;G.set("D",r=>new j(r,Nt));G.set("s",r=>new ei(r));const A=new Map;A.set("#",r=>new ze(r));A.set("A",r=>new j(r,Dt));A.set("E",r=>new U(r));A.set("5",r=>new L(r,Pt));A.set("6",r=>new L(r,Rt));const E=new Map;E.set(".",r=>new m(r,{ch:".",fg:ne}));E.set("`",r=>new De(r));E.set("O",r=>new Ce(r));E.set("o",r=>new Ht(r));E.set("=",r=>new C(r));E.set("/",r=>new K(r));E.set(",",r=>new K(r,!0));E.set("]",r=>new K(r,!1,!0));E.set("|",r=>new K(r,!0,!0));E.set("~",r=>new de(r,!0));E.set(" ",r=>new de(r));E.set("I",r=>new O(r,{broken:!0}));E.set("z",r=>new Q(r,"z"));E.set("x",r=>new Q(r,"x"));E.set("c",r=>new Q(r,"c"));E.set("v",r=>new Q(r,"v"));function ii(r,e){if(r==="@")return{terrain:new m(e,{ch:".",fg:ne}),special:null};if(x.has(r)){let t=x.get(r);return{terrain:new m(e,{ch:".",fg:ne}),special:t(e)}}else if(G.has(r)){let t=G.get(r);return{terrain:new K(e,!0),special:t(e)}}else if(A.has(r)){let t=A.get(r);return{terrain:new De(e),special:t(e)}}else return E.has(r)?{terrain:E.get(r)(e),special:null}:{terrain:new m(e,{ch:r,fg:"red"}),special:null}}const si=`                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                 .....                                                                        
                              ..........                                                                      
                            .............                                                                     
                            ......oo......                                                                    
                             ....ooo......                                                                    
                              ....oo......                                                                    
                              ...........                                                                     
                               ..........                                                                     
                                 .....                                                                        
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
`,ri="                                                                                                              \n                                                                                                              \n                                                                                                              \n                                                                                                              \n  =====================================================================~~==================================== \n  ======]]]]]]]]================...==///...===.....===....X.Y.========.~~===.....==....=============```====== \n  =====]]]]]]]]]]]]======$$$$.......//,,.....==...///......0..b.==..%..~~===..=..........=========```````==== \n  ====]]]]]||||]]]]]=====$=====.......,/=........==///.............==..~~====.==...====...=======```==````=== \n  ===///]]||]]|]||]]]====$$===......../==........=====...........===..~~~..=====..======..=======``=====```== \n  ===/////|]]||]||]]======$$==.==....../=...==....==.==..........==...~~~..=====..======..==.====``======``== \n  ==//,,,||]]|]|||]]]======$=====...=...=======.......==......./===..~~~...====..======..===..===```=====```= \n  =//,,,,,/]]|||]|]]]]]===$$====...===.==//...........==....../===..~~~....==....======..===...===```=====``= \n  =/,,....,/]]|]||||||]]]]$=====%%%========/...........=%%%%==/===..~~~....=....=======...=....===```=====``= \n  =/,..*..,//]]||]]]]|||||$=====...====..===...==.....z.....=//==...~~~.......==========.....=====```=====``= \n  =/,.....,///]]]]]]]]]]]]==........==....==/===......z.....==/==..~~~........==...==============```=====```= \n  =//,..,///////]]//]]///==................=======/====....=====...~~~.........c....===========```=======``== \n  ==//,,////,,,/////////==......................==============.....~~~.........c.....========````=======```== \n  ==////////,/,,,,,,,///=.....t............p...........===........I~~I....4....==.....======```====````````== \n  ==///////,,/,,/,,//////.........OO...............................~~~~~......===c.=...=====``====``5`````=== \n  ===//,,/,,,,,/,,,,/////......@.OOO.1.............==.......===.3..~~..~~.....==..===..=====``=======````==== \n  ===//,/,,/,////,,,/////.........OO..............========$======f..~~..~~........===`.=====```=====``````=== \n  ===//,,,//,,////,,,,,,...2.....................=========$$$======.~~..~~..=/....==```======``=====``==``=== \n  ===///,,,,,/////,,,,,/.......................=============$$$====.~~~~~~..==...===``=======``=====``===`=== \n  ==///,,///,,//,,,,,,//................=....======```========$===...~~~~....=..===```======```====```==/``== \n  ==///,/,,/,,//,//,,,,..===...=.......===.9.=====````========$====..~~~.......====```=====```===````===//`== \n  ==///,,,/,,,//,,,///,.=========.=================``=========$====..~~~...=========`````````====`=``====//== \n  ==///,,/,,/,,///,,////=========%%x......========```=========$$$===..~~~...==========``````=======``=====//= \n  ==//////,,,,//,,,/////=====``====........#.````#``============$$===.~~~...=======================``======== \n  ===//////////,,//,/////====````========....``#```====    ======$====~~~...]=====================.vv`======= \n  ==/////,,,///,,/,,/////==.``````======....#```=====       ..===$$$==~~~..|]]]==///=============....``====== \n  =//////,/////,,,,/,,///==`````#``===r..6##````====         ..==$=$==~~~.]|||]==////=/=====/==/......``===== \n  =///,,,,/////,//,,,,//===``````##`#`#A##``````===   ...     ..=$=$==~~~==]]|]===///////=//////......```==== \n  =//,,,/,,,,//,,,/,,,//==````#```#``####``#````===   .*.     ..$$=$==~~~====|]]=]/////////=/.//.......```=== \n  ///,,,,,,/,,///,,/,//===```````````E#`##``````===   ...     ..===$$==~~====.]]]]]L.....//=/....o..o..```/== \n  ///,,,,,,,,,,,,,/////===``````#``````#`````#```===         ..=====$==~~~.....||]*..///../====....7.o.```/== \n  ////,s,D,//,,,/==========``````````````===`````====       ..====$$$===~~~..8.]|]..//....//==/...o...``//=== \n  /////,/,,/////===========`````==```````===```#``=====    =======$====..~~~...]|||]//.//../////......///==== \n  /////,,,/////=============``======```========````===============$$$....~~~~.==]]]///.///.../...//////====== \n  //////////////==========================================================~~~.===//////////......//==//====== \n  ///////////////=========================================================~~~.==///////////////////////====== \n",ni=si,li=ri;class Ue{constructor(e){h(this,"_size");h(this,"_specialEntities");h(this,"_map");h(this,"_fovCells",[]);h(this,"textBuffer");h(this,"game");h(this,"player");h(this,"ev");h(this,"_inventory",{});h(this,"activeItem",null);h(this,"powerLevel",1);h(this,"battery",0);h(this,"loDiscovered",!1);h(this,"loOnShip",!1);this.game=e,this._specialEntities=[],this._map={},this._size=new p(110,41),this.player=new Ut(e),this.player.setPosition(new p(0,0),this),this._generateMap(ni),this.textBuffer=new Xt(this.game);let t=this.getSize(),i=3;this.textBuffer.configure({position:new p(0,0),size:new p(t.x,i)}),this.textBuffer.clear(),e.scheduler.clear(),e.scheduler.add(this.player,!0),this.textBuffer.write(`Where did everyone go?

Use the arrow keys or WASD to move.`)}onKeyDown(e){this.textBuffer.clear(),this.textBuffer.showing?e.key==="Enter"&&this.textBuffer.clearDisplayBox():e.key===this.activeItem?this.deactivateItem(e.key):e.key in this._inventory?this.activateItem(e.key):this.player.onKeyDown(e)}activateItem(e){if(this.battery===0){this.textBuffer.write("The power cell is dead.");return}let t=this._inventory[e];t.setPower(),t.onActivate()&&(this.activeItem&&this.deactivateItem(this.activeItem),this.activeItem=t.key,this._drawInventory(),this.updateFOV())}deactivateItem(e){this._inventory[e].onDeactivate()&&(this.activeItem=null,this._drawInventory(),this.updateFOV())}draw(e){var a;if(this.player.visible&&((a=this.player.getXY())==null?void 0:a.toString())===e.toString()){let{ch:o,fg:c}=this.player.getVisual();this.game.display.draw(e.x,e.y,o,c);return}let t=this.getEntityAt(e,!1,!0),i=this.getEntityAt(e,!0,!1);if(!t&&!i)return;if(!((t==null?void 0:t.visible)||(i==null?void 0:i.visible))){this.game.display.draw(e.x,e.y," ","white");return}let l=this.getEntityAt(e).getVisual();this.game.display.draw(e.x,e.y,l.ch,l.fg)}addInventory(e){this._inventory[e.key]=e,e instanceof ke&&(this.ev.remote=e),this.drawPower(),this._drawInventory()}getSize(){return this._size}setEntity(e,t){e.setPosition(t,this),this._map[t.toString()]=e,this.draw(t)}getEntityAt(e,t=!1,i=!1){const s=this._specialEntities.find(l=>{var a;return(l.visible||t)&&((a=l.getXY())==null?void 0:a.toString())==e.toString()});if(s)return s;const n=this._map[e.toString()];return n&&(n.visible||i)?n:null}setSpecialEntity(e,t){this._specialEntities.push(e),e.setPosition(t,this),this.draw(t)}removeSpecialEntity(e){this._specialEntities=this._specialEntities.filter(i=>i!=e);let t=this.getEntityAt(e.getXY(),!1,!0);t&&(t.visible=!0),this.draw(e.getXY())}isSpecial(e){return this._specialEntities.includes(e)}updateFOV(){for(;this._fovCells.length;)this.draw(this._fovCells.pop());let e=this.activeItem&&this._inventory[this.activeItem];if(!e)return;e.setPower();let t=e&&e.getFOV();if(!t)return;let{x:i,y:s}=this.player.getXY(),{r:n,fov:l,cb:a}=t,o=(c,u,f,_)=>{if(f===0||u<3||u>this._size.y-2)return;let d=new p(c,u);this._fovCells.push(d),a(c,u,f,_)};l instanceof Pe&&this.ev.playerIsRiding()?l.compute90(i,s,n,this.ev.direction,o):l.compute(i,s,n,o)}_drawInventory(){let{x:e,y:t}=this.getSize(),i=20;for(let s=i;s<e-1;s++)this.game.display.draw(s,t-1," ",null,null);for(let s of Object.keys(this._inventory).sort()){let n=this.activeItem===s?"*":" ",l=`%c{${this._inventory[s].color}}[${s}]%c{}`,a=this._inventory[s].name,o=l+n+a;this.game.display.drawText(i,t-1,o,e),i+=a.length+10}}drawNewShard(){let e=2+this.powerLevel,{x:t,y:i}=this.getSize(),s=i-1,n=new p(e,s),l=new J(this.game);l.visible=!0,this.setSpecialEntity(l,n),this.draw(n)}drawPower(){let{x:e,y:t}=this.getSize(),i=t-1,s=9,n=5,l=a=>{let o="#0f0";this.battery<4&&(o="#fa0"),this.battery<3&&(o="#f00");let c=a<this.battery?".":" ";this.game.display.draw(s+a,i,c,o)};this.game.display.draw(s-1,i,"["),this.game.display.draw(s+n,i,"]");for(let a=0;a<n;a++)l(a)}_generateMap(e){let t=li.split(`
`),i=e.split(`
`);for(let s=0;s<this._size.y;s++)for(let n=0;n<this._size.x;n++){let l=i[s][n]==" ",a=t[s][n],o=new p(n,s),c=this.getEntityAt(o);a==="@"&&(this.player.setPosition(o,this),a=".");let{terrain:u,special:f}=ii(a,this.game);f instanceof U&&(this.ev=f),l&&(u.visible=!1),this.setEntity(u,o),f&&this.setSpecialEntity(f,o),c&&(u.visible=c.visible),this.draw(o)}}}const ai=`                                                                                                              
                                                                                                              
  8""""                                   8   8                                8""""8                         
  8     eeeee eeeee eeee    eeeee eeee    8   8  eeeee eeeee e   e  e eeeee    8      eeeee eeeee eeee eeee   
  8eeee 8   8 8   8 8       8  88 8       8eee8e 8   8 8  88 8   8  8 8   8    8eeeee 8   8 8   8 8  8 8      
  88    8e  8 8e    8eee    8   8 8eee    88   8 8e  8 8   8 8e  8  8 8e  8        88 8eee8 8eee8 8e   8eee   
  88    88  8 88 "8 88      8   8 88      88   8 88  8 8   8 88  8  8 88  8    e   88 88    88  8 88   88     
  88eee 88ee8 88ee8 88ee    8eee8 88      88   8 88  8 8eee8 88ee8ee8 88  8    8eee88 88    88  8 88e8 88ee   
                                                                                                              
                                                                                                              
                                                                                                              
            *beep* Warning, emergency cryosleep pod activation sequence initiated *beep*                  
                                                                                                              
             \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\                        
                                                                                                              
                    Has it been a year already?                                                               
                                 ===                                                                          
         -----------------------|+@+|---------------------------------------------------                      
                                 ===                                                                          
                             Wait, what was that about an emergency?                                         
                                                         ===                                                  
        ------------------------------------------------|x x|-----------------------------                    
                                                         ===                                                  
                                                       Hey, where's Commander Lo?                             
                                 ===                                                                          
        ------------------------|x x|-----------------------------------------------------                    
                                 ===                                                                          
                       And Science Officer Balthar?                                                           
                                                         ===                                                  
          ----------------------------------------------|x x|---------------------------                      
                                                         ===                                                  
                                      And our two Security Officers?                                          
                                 ===                                                                          
            --------------------|x x|-------------------------------------------------                        
                                 ===                                                                          
                                                                                                              
                ////////////////////////////////////////////////////////////////////                          
                                                                                                              
                                Press [Enter] to leave the ship...                                        
                                                                                                              
`;class oi{constructor(e){h(this,"size",new p(110,40));h(this,"game");h(this,"_levelData",ai);h(this,"_state",1);h(this,"_interval");this.game=e,this._generateMap(),this._state++;let t=!0;this._interval=setInterval(()=>{this.game.display.draw(33,17,"+",t?"#0f0":"#0a0"),this.game.display.draw(35,17,"+",t?"#0f0":"#0a0"),t=!t},1e3)}draw(e){this._generateMap()}onKeyDown(e){e.key==="Enter"&&(this._state<7?(clearInterval(this._interval),this._generateMap()):(this._clear(),this.game.switchLevel(new Ue(this.game))),this._state++)}getSize(){return this.size}_clear(){for(let e=0;e<this.size.y;e++)for(let t=0;t<this.size.x;t++)this.game.display.draw(t,e," ",null,null)}_generateMap(){let e=this._levelData.split(`
`);for(let t=0;t<this.size.y;t++)for(let i=0;i<this.size.x;i++){let s=e[t][i];this._state===1&&([11,15,19,23,27,31].includes(t)&&(s=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to wake up from cryosleep...")),this._state>1&&(t==17&&[33,35].includes(i)&&(s="x"),t==17&&i===34&&(s=" "),t==17&&i===38&&(s="@")),this._state===2&&([15,19,23,27,31,38].includes(t)&&(s=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to continue...")),this._state===3&&([23,27,31,38].includes(t)&&(s=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to continue...")),this._state===4&&([27,31,38].includes(t)&&(s=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to continue....")),this._state===5&&([31,38].includes(t)&&(s=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to continue....."));let n=s==="x"?"#f00":s==="+"?"#0f0":s==="@"?"#ff0":"-\\/".includes(s)?"#666":"#ddd";t===11&&(n="#f00"),t===38&&(n="#ff0"),t<10&&(n="#f0f"),t<6&&(n="#0af"),t<4&&(n="#0ff"),this.game.display.draw(i,t,s,n)}}}class hi{constructor(e){h(this,"scheduler");h(this,"engine");h(this,"level");h(this,"display");h(this,"HANDLED_KEYS",["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","w","a","s","d","Enter","Escape"," "]);h(this,"_container");this.startBgTrack=e,this.scheduler=new Et.Speed,this.engine=new St(this.scheduler);const t=80;let i=window.innerWidth/t;window.addEventListener("resize",()=>{i=window.innerWidth/t,this.display.setOptions({fontSize:i})}),this.display=new N({fontSize:i}),this._container=this.display.getContainer(),this._container.classList.add("max-h-screen","max-w-full","scale-y-90"),document.body.appendChild(this._container);let s=new oi(this);this.level=s,this.switchLevel(s),this.engine.start(),window.addEventListener("keydown",this.onKeyDown.bind(this))}onKeyDown(e){this.HANDLED_KEYS.includes(e.key)&&e.preventDefault(),this.level.onKeyDown(e)}switchLevel(e){this.level=e,e instanceof Ue&&this.startBgTrack();let t=e.getSize();this.display.setOptions({width:t.x,height:t.y})}}window.addEventListener("load",Xe);function Xe(r){switch(r.type){case"load":ye("bg.ogg").catch(e=>{console.error(e),e.message.includes("Decoding")?(console.error(e),ye("bg.mp3").catch(t=>we(t.message))):we(e.message)})}window.removeEventListener("load",Xe)}function we(r){document.body.innerHTML=`
    <p>I'm sorry, there's been some trouble loading the sound file. If you see this, please try running it in a different browser.  Also, you can leave a comment with the error: "${r}"</p>
    `}const F=new AudioContext;async function ye(r){return ci(r).then(e=>{var t;(t=document.querySelector("p"))==null||t.remove(),new hi(()=>fi(e))})}async function ci(r){const t=await(await fetch(r)).arrayBuffer();return await F.decodeAudioData(t)}function ui(r){const e=F.createBufferSource();return e.buffer=r,e.connect(F.destination),e.start(),e.loop=!0,e}function fi(r){F.state==="suspended"&&F.resume(),ui(r)}
