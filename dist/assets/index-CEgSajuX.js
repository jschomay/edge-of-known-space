var ce=Object.defineProperty;var ue=(r,e,t)=>e in r?ce(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>ue(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const M=23283064365386963e-26;class X{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*M,e=e*69069+1>>>0,this._s1=e*M,e=e*69069+1>>>0,this._s2=e*M,this._c=1,this}getUniform(){let e=2091639*this._s0+this._c*M;return this._s0=this._s1,this._s1=this._s2,this._c=e|0,this._s2=e-this._c,this._s2}getUniformInt(e,t){let i=Math.max(e,t),s=Math.min(e,t);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(e=0,t=1){let i,s,n;do i=2*this.getUniform()-1,s=2*this.getUniform()-1,n=i*i+s*s;while(n>1||n==0);let o=i*Math.sqrt(-2*Math.log(n)/n);return e+o*t}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(e){return e.length?e[Math.floor(this.getUniform()*e.length)]:null}shuffle(e){let t=[],i=e.slice();for(;i.length;){let s=i.indexOf(this.getItem(i));t.push(i.splice(s,1)[0])}return t}getWeightedValue(e){let t=0;for(let o in e)t+=e[o];let i=this.getUniform()*t,s,n=0;for(s in e)if(n+=e[s],i<n)return s;return s}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this}clone(){return new X().setState(this.getState())}}const N=new X().setSeed(Date.now());class Y{getContainer(){return null}setOptions(e){this._options=e}}class H extends Y{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(e){requestAnimationFrame(e)}getContainer(){return this._ctx.canvas}setOptions(e){super.setOptions(e);const i=`${e.fontStyle?`${e.fontStyle} `:""} ${e.fontSize}px ${e.fontFamily}`;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const e=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=e}eventToPosition(e,t){let i=this._ctx.canvas,s=i.getBoundingClientRect();return e-=s.left,t-=s.top,e*=i.width/s.width,t*=i.height/s.height,e<0||t<0||e>=i.width||t>=i.height?[-1,-1]:this._normalizedEventToPosition(e,t)}}function fe(r,e){return(r%e+e)%e}function J(r,e=0,t=1){return r<e?e:r>t?t:r}class Q extends H{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(e,t){let[i,s,n,o,a]=e,l=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&l.reverse(),t&&(this._ctx.fillStyle=a,this._fill(l[0],l[1])),!n)return;this._ctx.fillStyle=o;let h=[].concat(n);for(let c=0;c<h.length;c++)this._ctx.fillText(h[c],l[0],Math.ceil(l[1]))}computeSize(e,t){this._options.transpose&&(e+=t,t=e-t,e-=t);let i=Math.floor(e/this._spacingX)-1,s=Math.floor((t-2*this._hexSize)/this._spacingY+1);return[i,s]}computeFontSize(e,t){this._options.transpose&&(e+=t,t=e-t,e-=t);let i=2*e/((this._options.width+1)*Math.sqrt(3))-1,s=t/(2+1.5*(this._options.height-1)),n=Math.min(i,s),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let l=a/100;n=Math.floor(n)+1;let h=2*n/(this._options.spacing*(1+l/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(e,t){let i;this._options.transpose?(e+=t,t=e-t,e-=t,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return t=Math.floor(t/s),fe(t,2)?(e-=this._spacingX,e=1+2*Math.floor(e/(2*this._spacingX))):e=2*Math.floor(e/(2*this._spacingX)),[e,t]}_fill(e,t){let i=this._hexSize,s=this._options.border;const n=this._ctx;n.beginPath(),this._options.transpose?(n.moveTo(e-i+s,t),n.lineTo(e-i/2+s,t+this._spacingX-s),n.lineTo(e+i/2-s,t+this._spacingX-s),n.lineTo(e+i-s,t),n.lineTo(e+i/2-s,t-this._spacingX+s),n.lineTo(e-i/2+s,t-this._spacingX+s),n.lineTo(e-i+s,t)):(n.moveTo(e,t-i+s),n.lineTo(e+this._spacingX-s,t-i/2+s),n.lineTo(e+this._spacingX-s,t+i/2-s),n.lineTo(e,t+i-s),n.lineTo(e-this._spacingX+s,t+i/2-s),n.lineTo(e-this._spacingX+s,t-i/2+s),n.lineTo(e,t-i+s)),n.fill()}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(e.spacing*(e.fontSize+t/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=this._hexSize*1.5;let i,s;e.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((e.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((e.height-1)*this._spacingY+2*this._hexSize)}}class O extends H{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(e){super.setOptions(e),this._canvasCache={}}draw(e,t){O.cache?this._drawWithCache(e):this._drawNoCache(e,t)}_drawWithCache(e){let[t,i,s,n,o]=e,a=""+s+n+o,l;if(a in this._canvasCache)l=this._canvasCache[a];else{let h=this._options.border;l=document.createElement("canvas");let c=l.getContext("2d");if(l.width=this._spacingX,l.height=this._spacingY,c.fillStyle=o,c.fillRect(h,h,l.width-h,l.height-h),s){c.fillStyle=n,c.font=this._ctx.font,c.textAlign="center",c.textBaseline="middle";let f=[].concat(s);for(let p=0;p<f.length;p++)c.fillText(f[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=l}this._ctx.drawImage(l,t*this._spacingX,i*this._spacingY)}_drawNoCache(e,t){let[i,s,n,o,a]=e;if(t){let h=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(i*this._spacingX+h,s*this._spacingY+h,this._spacingX-h,this._spacingY-h)}if(!n)return;this._ctx.fillStyle=o;let l=[].concat(n);for(let h=0;h<l.length;h++)this._ctx.fillText(l[h],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(e,t){let i=Math.floor(e/this._spacingX),s=Math.floor(t/this._spacingY);return[i,s]}computeFontSize(e,t){let i=Math.floor(e/this._options.width),s=Math.floor(t/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let l=o/100*s/i;return l>1&&(s=Math.floor(s/l)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(e.spacing*t),this._spacingY=Math.ceil(e.spacing*e.fontSize),e.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=e.width*this._spacingX,this._ctx.canvas.height=e.height*this._spacingY}}O.cache=!1;class Z extends H{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(e,t){let[i,s,n,o,a]=e,l=this._options.tileWidth,h=this._options.tileHeight;if(t&&(this._options.tileColorize?this._ctx.clearRect(i*l,s*h,l,h):(this._ctx.fillStyle=a,this._ctx.fillRect(i*l,s*h,l,h))),!n)return;let c=[].concat(n),f=[].concat(o),p=[].concat(a);for(let _=0;_<c.length;_++){let d=this._options.tileMap[c[_]];if(!d)throw new Error(`Char "${c[_]}" not found in tileMap`);if(this._options.tileColorize){let m=this._colorCanvas,w=m.getContext("2d");w.globalCompositeOperation="source-over",w.clearRect(0,0,l,h);let v=f[_],E=p[_];w.drawImage(this._options.tileSet,d[0],d[1],l,h,0,0,l,h),v!="transparent"&&(w.fillStyle=v,w.globalCompositeOperation="source-atop",w.fillRect(0,0,l,h)),E!="transparent"&&(w.fillStyle=E,w.globalCompositeOperation="destination-over",w.fillRect(0,0,l,h)),this._ctx.drawImage(m,i*l,s*h,l,h)}else this._ctx.drawImage(this._options.tileSet,d[0],d[1],l,h,i*l,s*h,l,h)}}computeSize(e,t){let i=Math.floor(e/this._options.tileWidth),s=Math.floor(t/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._options;this._ctx.canvas.width=e.width*e.tileWidth,this._ctx.canvas.height=e.height*e.tileHeight,this._colorCanvas.width=e.tileWidth,this._colorCanvas.height=e.tileHeight}}function G(r){let e,t;if(r in D)e=D[r];else{if(r.charAt(0)=="#"){let s=(r.match(/[0-9a-f]/gi)||[]).map(n=>parseInt(n,16));if(s.length==3)e=s.map(n=>n*17);else{for(let n=0;n<3;n++)s[n+1]+=16*s[n],s.splice(n,1);e=s}}else(t=r.match(/rgb\(([0-9, ]+)\)/i))?e=t[1].split(/\s*,\s*/).map(i=>parseInt(i)):e=[0,0,0];D[r]=e}return e.slice()}function _e(r,...e){let t=r.slice();for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function de(r,...e){for(let t=0;t<3;t++)for(let i=0;i<e.length;i++)r[t]+=e[i][t];return r}function pe(r,...e){let t=r.slice();for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function ge(r,...e){for(let t=0;t<3;t++){for(let i=0;i<e.length;i++)r[t]*=e[i][t]/255;r[t]=Math.round(r[t])}return r}function ee(r,e,t=.5){let i=r.slice();for(let s=0;s<3;s++)i[s]=Math.round(i[s]+t*(e[s]-r[s]));return i}const me=ee;function te(r,e,t=.5){let i=B(r),s=B(e);for(let n=0;n<3;n++)i[n]+=t*(s[n]-i[n]);return ie(i)}const we=te;function ve(r,e){e instanceof Array||(e=Math.round(N.getNormal(0,e)));let t=r.slice();for(let i=0;i<3;i++)t[i]+=e instanceof Array?Math.round(N.getNormal(0,e[i])):e;return t}function B(r){let e=r[0]/255,t=r[1]/255,i=r[2]/255,s=Math.max(e,t,i),n=Math.min(e,t,i),o=0,a,l=(s+n)/2;if(s==n)a=0;else{let h=s-n;switch(a=l>.5?h/(2-s-n):h/(s+n),s){case e:o=(t-i)/h+(t<i?6:0);break;case t:o=(i-e)/h+2;break;case i:o=(e-t)/h+4;break}o/=6}return[o,a,l]}function A(r,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?r+(e-r)*6*t:t<1/2?e:t<2/3?r+(e-r)*(2/3-t)*6:r}function ie(r){let e=r[2];if(r[1]==0)return e=Math.round(e*255),[e,e,e];{let t=r[1],i=e<.5?e*(1+t):e+t-e*t,s=2*e-i,n=A(s,i,r[0]+1/3),o=A(s,i,r[0]),a=A(s,i,r[0]-1/3);return[Math.round(n*255),Math.round(o*255),Math.round(a*255)]}}function ye(r){return`rgb(${r.map(t=>J(t,0,255)).join(",")})`}function xe(r){return`#${r.map(t=>J(t,0,255).toString(16).padStart(2,"0")).join("")}`}const D={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]},Ee=Object.freeze(Object.defineProperty({__proto__:null,add:_e,add_:de,fromString:G,hsl2rgb:ie,interpolate:ee,interpolateHSL:te,lerp:me,lerpHSL:we,multiply:pe,multiply_:ge,randomize:ve,rgb2hsl:B,toHex:xe,toRGB:ye},Symbol.toStringTag,{value:"Module"}));class se extends Y{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(e){typeof e=="string"?alert(e):e instanceof Error&&alert(e.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(e){requestAnimationFrame(e)}getContainer(){return this._gl.canvas}setOptions(e){super.setOptions(e),this._updateSize();let t=this._options.tileSet;t&&"complete"in t&&!t.complete?t.addEventListener("load",()=>this._updateTexture(t)):this._updateTexture(t)}draw(e,t){const i=this._gl,s=this._options;let[n,o,a,l,h]=e,c=i.canvas.height-(o+1)*s.tileHeight;if(i.scissor(n*s.tileWidth,c,s.tileWidth,s.tileHeight),t&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...R(h)),i.clear(i.COLOR_BUFFER_BIT)),!a)return;let f=[].concat(a),p=[].concat(h),_=[].concat(l);i.uniform2fv(this._uniforms.targetPosRel,[n,o]);for(let d=0;d<f.length;d++){let m=this._options.tileMap[f[d]];if(!m)throw new Error(`Char "${f[d]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,m),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,R(_[d])),i.uniform4fv(this._uniforms.bg,R(p[d]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const e=this._gl;e.clearColor(...R(this._options.bg)),e.scissor(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}computeSize(e,t){let i=Math.floor(e/this._options.tileWidth),s=Math.floor(t/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(e,t){let i=this._gl.canvas,s=i.getBoundingClientRect();return e-=s.left,t-=s.top,e*=i.width/s.width,t*=i.height/s.height,e<0||t<0||e>=i.width||t>=i.height?[-1,-1]:this._normalizedEventToPosition(e,t)}_initWebGL(){let e=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=e;let t=Te(e,Se,Ve);return e.useProgram(t),Ke(e),be.forEach(i=>this._uniforms[i]=e.getUniformLocation(t,i)),this._program=t,e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.SCISSOR_TEST),e}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._gl,t=this._options,i=[t.width*t.tileWidth,t.height*t.tileHeight];e.canvas.width=i[0],e.canvas.height=i[1],e.viewport(0,0,i[0],i[1]),e.uniform2fv(this._uniforms.tileSize,[t.tileWidth,t.tileHeight]),e.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(e){Ce(this._gl,e)}}const be=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],Se=`
#version 300 es

in vec2 tilePosRel;
out vec2 tilesetPosPx;

uniform vec2 tilesetPosAbs;
uniform vec2 tileSize;
uniform vec2 targetSize;
uniform vec2 targetPosRel;

void main() {
	vec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;
	vec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;
	targetPosNdc.y *= -1.0;

	gl_Position = vec4(targetPosNdc, 0.0, 1.0);
	tilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;
}`.trim(),Ve=`
#version 300 es
precision highp float;

in vec2 tilesetPosPx;
out vec4 fragColor;
uniform sampler2D image;
uniform bool colorize;
uniform vec4 bg;
uniform vec4 tint;

void main() {
	fragColor = vec4(0, 0, 0, 1);

	vec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);

	if (colorize) {
		texel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;
		fragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;
		fragColor.a = texel.a + (1.0-texel.a)*bg.a;
	} else {
		fragColor = texel;
	}
}`.trim();function Te(r,e,t){const i=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(i)||"");const s=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(s,t),r.compileShader(s),!r.getShaderParameter(s,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(s)||"");const n=r.createProgram();if(r.attachShader(n,i),r.attachShader(n,s),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(n)||"");return n}function Ke(r){const e=new Float32Array([0,0,1,0,0,1,1,1]),t=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW),r.enableVertexAttribArray(0),r.vertexAttribPointer(0,2,r.FLOAT,!1,0,0)}function Ce(r,e){let t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.REPEAT),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),t}let F={};function R(r){if(!(r in F)){let e;if(r=="transparent")e=[0,0,0,0];else if(r.indexOf("rgba")>-1){e=(r.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=G(r).map(t=>t/255),e.push(1);F[r]=e}return F[r]}function Pe(r){return`\x1B[0;48;5;${U(r)}m\x1B[2J`}function Ie(r,e){return`\x1B[0;38;5;${U(r)};48;5;${U(e)}m`}function Oe(r,e){return`\x1B[${e+1};${r+1}H`}function U(r){const i=.0234375;let s=G(r),n=Math.floor(s[0]*i),o=Math.floor(s[1]*i),a=Math.floor(s[2]*i);return n*36+o*6+a*1+16}class ne extends Y{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(e){setTimeout(e,1e3/60)}setOptions(e){super.setOptions(e);let t=[e.width,e.height],i=this.computeSize();this._offset=i.map((s,n)=>Math.floor((s-t[n])/2))}clear(){process.stdout.write(Pe(this._options.bg))}draw(e,t){let[i,s,n,o,a]=e,l=this._offset[0]+i,h=this._offset[1]+s,c=this.computeSize();if(l<0||l>=c[0]||h<0||h>=c[1]||((l!==this._cursor[0]||h!==this._cursor[1])&&(process.stdout.write(Oe(l,h)),this._cursor[0]=l,this._cursor[1]=h),t&&(n||(n=" ")),!n))return;let f=Ie(o,a);if(f!==this._lastColor&&(process.stdout.write(f),this._lastColor=f),n!="	"){let p=[].concat(n);process.stdout.write(p[0])}this._cursor[0]++,this._cursor[0]>=c[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(e,t){return[e,t]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const Le=/%([bc]){([^}]*)}/g,C=0,I=1,re=2,oe=3;function Me(r,e){let t=[],i=0;r.replace(Le,function(n,o,a,l){let h=r.substring(i,l);return h.length&&t.push({type:C,value:h}),t.push({type:o=="c"?re:oe,value:a.trim()}),i=l+n.length,""});let s=r.substring(i);return s.length&&t.push({type:C,value:s}),Re(t,e)}function Re(r,e){e||(e=1/0);let t=0,i=0,s=-1;for(;t<r.length;){let o=r[t];if(o.type==I&&(i=0,s=-1),o.type!=C){t++;continue}for(;i==0&&o.value.charAt(0)==" ";)o.value=o.value.substring(1);let a=o.value.indexOf(`
`);if(a!=-1){o.value=k(r,t,a,!0);let l=o.value.split("");for(;l.length&&l[l.length-1]==" ";)l.pop();o.value=l.join("")}if(!o.value.length){r.splice(t,1);continue}if(i+o.value.length>e){let l=-1;for(;;){let h=o.value.indexOf(" ",l+1);if(h==-1||i+h>e)break;l=h}if(l!=-1)o.value=k(r,t,l,!0);else if(s!=-1){let h=r[s],c=h.value.lastIndexOf(" ");h.value=k(r,s,c,!0),t=s}else o.value=k(r,t,e-i,!1)}else i+=o.value.length,o.value.indexOf(" ")!=-1&&(s=t);t++}r.push({type:I});let n=null;for(let o=0;o<r.length;o++){let a=r[o];switch(a.type){case C:n=a;break;case I:if(n){let l=n.value.split("");for(;l.length&&l[l.length-1]==" ";)l.pop();n.value=l.join("")}n=null;break}}return r.pop(),r}function k(r,e,t,i){let s={type:I},n={type:C,value:r[e].value.substring(t+(i?1:0))};return r.splice(e+1,0,s,n),r[e].value.substring(0,t)}let ke=80,Ne=25;const V={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},y={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},ze={hex:Q,rect:O,tile:Z,"tile-gl":se,term:ne},Ae={width:ke,height:Ne,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class P{constructor(e={}){this._data={},this._dirty=!1,this._options={},e=Object.assign({},Ae,e),this.setOptions(e),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(e,t,i){let s=[this._options.bg,this._options.fg];this.draw(e,t,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(e){if(Object.assign(this._options,e),e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){if(e.layout){let t=ze[e.layout];this._backend=new t}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(e,t){return this._backend.computeSize(e,t)}computeFontSize(e,t){return this._backend.computeFontSize(e,t)}computeTileSize(e,t){let i=Math.floor(e/this._options.width),s=Math.floor(t/this._options.height);return[i,s]}eventToPosition(e){let t,i;return"touches"in e?(t=e.touches[0].clientX,i=e.touches[0].clientY):(t=e.clientX,i=e.clientY),this._backend.eventToPosition(t,i)}draw(e,t,i,s,n){s||(s=this._options.fg),n||(n=this._options.bg);let o=`${e},${t}`;this._data[o]=[e,t,i,s,n],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawOver(e,t,i,s,n){const o=`${e},${t}`,a=this._data[o];a?(a[2]=i||a[2],a[3]=s||a[3],a[4]=n||a[4]):this.draw(e,t,i,s,n)}drawText(e,t,i,s){let n=null,o=null,a=e,l=t,h=1;s||(s=this._options.width-e);let c=Me(i,s);for(;c.length;){let f=c.shift();switch(f.type){case C:let p=!1,_=!1,d=!1,m=!1;for(let w=0;w<f.value.length;w++){let v=f.value.charCodeAt(w),E=f.value.charAt(w);if(this._options.layout==="term"){let b=v>>8;if(b===17||b>=46&&b<=159||b>=172&&b<=215||v>=43360&&v<=43391){this.draw(a+0,l,E,n,o),this.draw(a+1,l,"	",n,o),a+=2;continue}}d=v>65280&&v<65377||v>65500&&v<65512||v>65518,p=E.charCodeAt(0)==32||E.charCodeAt(0)==12288,m&&!d&&!p&&a++,d&&!_&&a++,this.draw(a++,l,E,n,o),_=p,m=d}break;case re:n=f.value||null;break;case oe:o=f.value||null;break;case I:a=e,l++,h++;break}}return h}_tick(){if(this._backend.schedule(this._tick),!!this._dirty){if(this._dirty===!0){this._backend.clear();for(let e in this._data)this._draw(e,!1)}else for(let e in this._dirty)this._draw(e,!0);this._dirty=!1}}_draw(e,t){let i=this._data[e];i[4]!=this._options.bg&&(t=!0),this._backend.draw(i,t)}}P.Rect=O;P.Hex=Q;P.Tile=Z;P.TileGL=se;P.Term=ne;class j{constructor(){this.heap=[],this.timestamp=0}lessThan(e,t){return e.key==t.key?e.timestamp<t.timestamp:e.key<t.key}shift(e){this.heap=this.heap.map(({key:t,value:i,timestamp:s})=>({key:t+e,value:i,timestamp:s}))}len(){return this.heap.length}push(e,t){this.timestamp+=1;const i=this.len();this.heap.push({value:e,timestamp:this.timestamp,key:t}),this.updateUp(i)}pop(){if(this.len()==0)throw new Error("no element to pop");const e=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),e}find(e){for(let t=0;t<this.len();t++)if(e==this.heap[t].value)return this.heap[t];return null}remove(e){let t=null;for(let i=0;i<this.len();i++)e==this.heap[i].value&&(t=i);if(t===null)return!1;if(this.len()>1){let i=this.heap.pop();return i.value!=e&&(this.heap[t]=i,this.updateDown(t)),!0}else this.heap.pop();return!0}parentNode(e){return Math.floor((e-1)/2)}leftChildNode(e){return 2*e+1}rightChildNode(e){return 2*e+2}existNode(e){return e>=0&&e<this.heap.length}swap(e,t){const i=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=i}minNode(e){const t=e.filter(this.existNode.bind(this));let i=t[0];for(const s of t)this.lessThan(this.heap[s],this.heap[i])&&(i=s);return i}updateUp(e){if(e==0)return;const t=this.parentNode(e);this.existNode(t)&&this.lessThan(this.heap[e],this.heap[t])&&(this.swap(e,t),this.updateUp(t))}updateDown(e){const t=this.leftChildNode(e),i=this.rightChildNode(e);if(!this.existNode(t))return;const s=this.minNode([e,t,i]);s!=e&&(this.swap(e,s),this.updateDown(s))}debugPrint(){console.log(this.heap)}}class De{constructor(){this._time=0,this._events=new j}getTime(){return this._time}clear(){return this._events=new j,this}add(e,t){this._events.push(e,t)}get(){if(!this._events.len())return null;let{key:e,value:t}=this._events.pop();return e>0&&(this._time+=e,this._events.shift(-e)),t}getEventTime(e){const t=this._events.find(e);if(t){const{key:i}=t;return i}}remove(e){return this._events.remove(e)}}class q{constructor(){this._queue=new De,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(e,t){return t&&this._repeat.push(e),this}getTimeOf(e){return this._queue.getEventTime(e)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(e){let t=this._queue.remove(e),i=this._repeat.indexOf(e);return i!=-1&&this._repeat.splice(i,1),this._current==e&&(this._current=null),t}next(){return this._current=this._queue.get(),this._current}}class Fe extends q{add(e,t){return this._queue.add(e,0),super.add(e,t)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,0),super.next()}}class Be extends q{add(e,t,i){return this._queue.add(e,i!==void 0?i:1/e.getSpeed()),super.add(e,t)}next(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}class Ue extends q{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(e,t,i){return this._queue.add(e,i||this._defaultDuration),super.add(e,t)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(e){return e==this._current&&(this._duration=this._defaultDuration),super.remove(e)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(e){return this._current&&(this._duration=e),this}}const Xe={Simple:Fe,Speed:Be,Action:Ue};class W{constructor(e,t={}){this._lightPasses=e,this._options=Object.assign({topology:8},t)}_getCircle(e,t,i){let s=[],n,o,a;switch(this._options.topology){case 4:o=1,a=[0,1],n=[V[8][7],V[8][1],V[8][3],V[8][5]];break;case 6:n=V[6],o=1,a=[-1,1];break;case 8:n=V[4],o=2,a=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let l=e+a[0]*i,h=t+a[1]*i;for(let c=0;c<n.length;c++)for(let f=0;f<i*o;f++)s.push([l,h]),l+=n[c][0],h+=n[c][1];return s}}class Ye extends W{compute(e,t,i,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;let n=[],o,a,l,h,c;for(let f=1;f<=i;f++){let p=this._getCircle(e,t,f),_=360/p.length;for(let d=0;d<p.length;d++)if(l=p[d][0],h=p[d][1],o=_*(d-.5),a=o+_,c=!this._lightPasses(l,h),this._visibleCoords(Math.floor(o),Math.ceil(a),c,n)&&s(l,h,f,1),n.length==2&&n[0]==0&&n[1]==360)return}}_visibleCoords(e,t,i,s){if(e<0){let a=this._visibleCoords(0,t,i,s),l=this._visibleCoords(360+e,360,i,s);return a||l}let n=0;for(;n<s.length&&s[n]<e;)n++;if(n==s.length)return i&&s.push(e,t),!0;let o=0;if(n%2){for(;n<s.length&&s[n]<t;)n++,o++;return o==0?!1:(i&&(o%2?s.splice(n-o,o,t):s.splice(n-o,o)),!0)}else{for(;n<s.length&&s[n]<t;)n++,o++;return e==s[n-o]&&o==1?!1:(i&&(o%2?s.splice(n-o,o,e):s.splice(n-o,o,e,t)),!0)}}}class He extends W{compute(e,t,i,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;let n=[],o,a,l,h,c,f;for(let p=1;p<=i;p++){let _=this._getCircle(e,t,p),d=_.length;for(let m=0;m<d;m++)if(o=_[m][0],a=_[m][1],h=[m?2*m-1:2*d-1,2*d],c=[2*m+1,2*d],l=!this._lightPasses(o,a),f=this._checkVisibility(h,c,l,n),f&&s(o,a,p,f),n.length==2&&n[0][0]==0&&n[1][0]==n[1][1])return}}_checkVisibility(e,t,i,s){if(e[0]>t[0]){let _=this._checkVisibility(e,[e[1],e[1]],i,s),d=this._checkVisibility([0,1],t,i,s);return(_+d)/2}let n=0,o=!1;for(;n<s.length;){let _=s[n],d=_[0]*e[1]-e[0]*_[1];if(d>=0){d==0&&!(n%2)&&(o=!0);break}n++}let a=s.length,l=!1;for(;a--;){let _=s[a],d=t[0]*_[1]-_[0]*t[1];if(d>=0){d==0&&a%2&&(l=!0);break}}let h=!0;if((n==a&&(o||l)||o&&l&&n+1==a&&a%2||n>a&&n%2)&&(h=!1),!h)return 0;let c,f=a-n+1;if(f%2)if(n%2){let _=s[n];c=(t[0]*_[1]-_[0]*t[1])/(_[1]*t[1]),i&&s.splice(n,f,t)}else{let _=s[a];c=(_[0]*e[1]-e[0]*_[1])/(e[1]*_[1]),i&&s.splice(n,f,e)}else if(n%2){let _=s[n],d=s[a];c=(d[0]*_[1]-_[0]*d[1])/(_[1]*d[1]),i&&s.splice(n,f)}else return i&&s.splice(n,f,e,t),1;let p=(t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]);return c/p}}const S=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];class Ge extends W{compute(e,t,i,s){s(e,t,0,1);for(let n=0;n<S.length;n++)this._renderOctant(e,t,S[n],i,s)}compute180(e,t,i,s,n){n(e,t,0,1);let o=(s-1+8)%8,a=(s-2+8)%8,l=(s+1+8)%8;this._renderOctant(e,t,S[a],i,n),this._renderOctant(e,t,S[o],i,n),this._renderOctant(e,t,S[s],i,n),this._renderOctant(e,t,S[l],i,n)}compute90(e,t,i,s,n){n(e,t,0,1);let o=(s-1+8)%8;this._renderOctant(e,t,S[s],i,n),this._renderOctant(e,t,S[o],i,n)}_renderOctant(e,t,i,s,n){this._castVisibility(e,t,1,1,0,s+1,i[0],i[1],i[2],i[3],n)}_castVisibility(e,t,i,s,n,o,a,l,h,c,f){if(!(s<n))for(let p=i;p<=o;p++){let _=-p-1,d=-p,m=!1,w=0;for(;_<=0;){_+=1;let v=e+_*a+d*l,E=t+_*h+d*c,b=(_-.5)/(d+.5),L=(_+.5)/(d-.5);if(!(L>s)){if(b<n)break;if(_*_+d*d<o*o&&f(v,E,p,1),!m)!this._lightPasses(v,E)&&p<o&&(m=!0,this._castVisibility(e,t,p+1,s,b,o,a,l,h,c,f),w=L);else{if(!this._lightPasses(v,E)){w=L;continue}m=!1,s=w}}}if(m)break}}}const le={DiscreteShadowcasting:Ye,PreciseShadowcasting:He,RecursiveShadowcasting:Ge};class qe{constructor(e){this._scheduler=e,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let e=this._scheduler.next();if(!e)return this.lock();let t=e.act();t&&t.then&&(this.lock(),t.then(this.unlock.bind(this)))}return this}}const K=Ee;class g{constructor(e=0,t=0){u(this,"x");u(this,"y");this.x=e,this.y=t}toString(){return this.x+","+this.y}is(e){return this.x==e.x&&this.y==e.y}dist8(e){let t=e.x-this.x,i=e.y-this.y;return Math.max(Math.abs(t),Math.abs(i))}dist4(e){let t=e.x-this.x,i=e.y-this.y;return Math.abs(t)+Math.abs(i)}dist(e){let t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}plus(e){return new g(this.x+e.x,this.y+e.y)}minus(e){return new g(this.x-e.x,this.y-e.y)}}const We=[[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," ","8",'"','"','"','"'," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","8"," "," "," ","8"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","8",'"','"','"','"',"8"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," ","8"," "," "," "," "," ","e","e","e","e","e"," ","e","e","e","e","e"," ","e","e","e","e"," "," "," "," ","e","e","e","e","e"," ","e","e","e","e"," "," "," "," ","8"," "," "," ","8"," "," ","e","e","e","e","e"," ","e","e","e","e","e"," ","e"," "," "," ","e"," "," ","e"," ","e","e","e","e","e"," "," "," "," ","8"," "," "," "," "," "," ","e","e","e","e","e"," ","e","e","e","e","e"," ","e","e","e","e"," ","e","e","e","e"," "," "," "],[" "," ","8","e","e","e","e"," ","8"," "," "," ","8"," ","8"," "," "," ","8"," ","8"," "," "," "," "," "," "," ","8"," "," ","8","8"," ","8"," "," "," "," "," "," "," ","8","e","e","e","8","e"," ","8"," "," "," ","8"," ","8"," "," ","8","8"," ","8"," "," "," ","8"," "," ","8"," ","8"," "," "," ","8"," "," "," "," ","8","e","e","e","e","e"," ","8"," "," "," ","8"," ","8"," "," "," ","8"," ","8"," "," ","8"," ","8"," "," "," "," "," "," "],[" "," ","8","8"," "," "," "," ","8","e"," "," ","8"," ","8","e"," "," "," "," ","8","e","e","e"," "," "," "," ","8"," "," "," ","8"," ","8","e","e","e"," "," "," "," ","8","8"," "," "," ","8"," ","8","e"," "," ","8"," ","8"," "," "," ","8"," ","8","e"," "," ","8"," "," ","8"," ","8","e"," "," ","8"," "," "," "," "," "," "," "," ","8","8"," ","8","e","e","e","8"," ","8","e","e","e","8"," ","8","e"," "," "," ","8","e","e","e"," "," "," "],[" "," ","8","8"," "," "," "," ","8","8"," "," ","8"," ","8","8"," ",'"',"8"," ","8","8"," "," "," "," "," "," ","8"," "," "," ","8"," ","8","8"," "," "," "," "," "," ","8","8"," "," "," ","8"," ","8","8"," "," ","8"," ","8"," "," "," ","8"," ","8","8"," "," ","8"," "," ","8"," ","8","8"," "," ","8"," "," "," "," ","e"," "," "," ","8","8"," ","8","8"," "," "," "," ","8","8"," "," ","8"," ","8","8"," "," "," ","8","8"," "," "," "," "," "],[" "," ","8","8","e","e","e"," ","8","8","e","e","8"," ","8","8","e","e","8"," ","8","8","e","e"," "," "," "," ","8","e","e","e","8"," ","8","8"," "," "," "," "," "," ","8","8"," "," "," ","8"," ","8","8"," "," ","8"," ","8","e","e","e","8"," ","8","8","e","e","8","e","e","8"," ","8","8"," "," ","8"," "," "," "," ","8","e","e","e","8","8"," ","8","8"," "," "," "," ","8","8"," "," ","8"," ","8","8","e","8"," ","8","8","e","e"," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," ","*","b","e","e","p","*"," ","W","a","r","n","i","n","g",","," ","r","e","s","e","r","v","e"," ","p","o","w","e","r"," ","l","e","v","e","l","s"," ","d","e","p","l","e","t","e","d","."," "," ","A","l","l"," ","s","y","s","t","e","m","s"," ","s","h","u","t","t","i","n","g"," ","d","o","w","n","."," ","*","b","e","e","p","*"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," ","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\","\\"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","H","a","s"," ","i","t"," ","b","e","e","n"," ","a"," ","y","e","a","r"," ","a","l","r","e","a","d","y","?"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," ","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","|","+","@","+","|","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","W","a","i","t",","," ","w","h","a","t"," ","w","a","s"," ","t","h","a","t"," ","a","b","o","u","t"," ","r","e","s","e","r","v","e"," ","p","o","w","e","r","?"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," ","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","|","x"," ","x","|","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","H","e","y",","," ","w","h","e","r","e","'","s"," ","C","o","m","m","a","n","d","e","r"," ","L","o","?"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," ","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","|","x"," ","x","|","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","A","n","d"," ","S","c","i","e","n","c","e"," ","O","f","f","i","c","e","r"," ","B","a","l","t","h","a","r","?"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," ","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","|","x"," ","x","|","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","A","n","d"," ","o","u","r"," ","t","w","o"," ","S","e","c","u","r","i","t","y"," ","O","f","f","i","c","e","r","s","?"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," ","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","|","x"," ","x","|","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","=","=","="," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/","/"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","P","r","e","s","s"," ","[","E","n","t","e","r","]"," ","t","o"," ","l","e","a","v","e"," ","t","h","e"," ","s","h","i","p",".",".","."," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "],[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "]];class x{constructor(e,t={ch:"!",fg:"red"}){u(this,"_visual");u(this,"_xy");u(this,"_level");u(this,"visible",!0);u(this,"game");this.game=e,this._visual=t}setVisual(e){this._visual={...this._visual,...e}}getVisual(){return this._visual}getXY(){return this._xy}getLevel(){return this._level}setPosition(e,t){return this._xy=e,t&&(this._level=t),this}remove(){var e;(e=this.getLevel())==null||e.removeSpecialEntity(this)}onInteract(e){return!0}}class je extends x{constructor(t){super(t,{ch:"@",fg:"yellow"});u(this,"_keys");u(this,"ready");this.ready=!0,this._keys={},this._keys[y.VK_UP]=0,this._keys[y.VK_W]=0,this._keys[y.VK_K]=0,this._keys[y.VK_RIGHT]=1,this._keys[y.VK_D]=1,this._keys[y.VK_L]=1,this._keys[y.VK_DOWN]=2,this._keys[y.VK_S]=2,this._keys[y.VK_J]=2,this._keys[y.VK_LEFT]=3,this._keys[y.VK_H]=3,this._keys[y.VK_A]=3,this._keys[y.VK_ENTER]=-1}getSpeed(){return 1}act(){this.getLevel().textBuffer.flush(),this.game.engine.lock(),this.ready=!0}onKeyDown(t){if(!this.ready)return;this._handleKey(t.keyCode)&&(this.ready=!1,this.game.engine.unlock())}_handleKey(t){if(!(t in this._keys))return!1;let i=this._keys[t];if(i==-1)return!0;let s=V[4][i],n=this.getXY().plus(new g(s[0],s[1])),o=this.getLevel().getEntityAt(n);return o?(o.onInteract(this)&&(this.moveTo(n),this.getLevel().updateFOV()),!0):(this.getLevel().textBuffer.write("I'm not equipped to explore into the unknown."),!1)}moveTo(t){let i=this.getXY();this.setPosition(t),this.getLevel().draw(i),this.getLevel().draw(t)}}class $e{constructor(e){u(this,"showing");u(this,"_data");u(this,"displayBoxPos");u(this,"displayBoxSize");u(this,"_options");u(this,"_cb");u(this,"game");this.showing=!1,this._data=[],this._options={display:e.display,position:new g,size:new g},this.displayBoxPos=new g(10,5),this.displayBoxSize=new g(90,25),this._cb=null,this.game=e}configure(e){Object.assign(this._options,e)}clear(){this._data=[]}write(e,t=!1){!t&&this.clear(),this._data.push(e),!t&&this.flush()}flush(){let e=this._options,t=e.display,i=e.position,s=e.size;for(let o=0;o<s.x;o++)for(let a=0;a<s.y;a++)t.draw(i.x+o,i.y+a);let n=this._data.join(" ");t.drawText(i.x,i.y,n,s.x)}displayBox(e,t=null){this._cb=t,this.showing=!0;let s=this._options.display,n=this.displayBoxPos,o=this.displayBoxSize;for(let c=0;c<o.x;c++)for(let f=0;f<o.y;f++)c===0||c===o.x-1||f===0||f===o.y-1?s.draw(n.x+c,n.y+f,"-"):s.draw(n.x+c,n.y+f," ");let a=5,l=n.x+a,h=n.y+a;s.drawText(l,h,e,o.x-a*2),s.drawText(l,n.y+o.y-3,"Press [Enter] to continue",o.x-a*2)}clearDisplayBox(){this.showing=!1;let t=this._options.display,i=this.displayBoxPos,s=this.displayBoxSize,n=new g;for(let o=0;o<s.x;o++)for(let a=0;a<s.y;a++)n.x=i.x+o,n.y=i.y+a,t.draw(n.x,n.y," "),this.game.level.draw(n);this._cb!==null&&(this._cb(),this._cb=null)}}const Je=`                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                 ....                                                                         
                                ........                                                                      
                              ...........                                                                     
                            .............                                                                     
                            ......oo......                                                                    
                             ....ooo.@....                                                                    
                              ....oo......                                                                    
                              ...........                                                                     
                               ..........                                                                     
                                 .....                                                                        
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
`,Qe=`                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                    =                                                                         
                               == ======                                                                      
                           == ============                                                                    
                          ======...====..==                                                                   
                       \\\\===..............=                                                                   
                      \\\\\\\\=................                                                                   
                     \\\\\\.....................                                                                 
                      \\\\.................t....                                                                
                    \\\\\\...........oo..........                                                                
                    \\\\\\......... ooo+@.......                                                                 
                     \\\\\\..........oo........                                                                  
                    \\\\\\\\+....................                                                                 
                    \\\\\\\\.....................                                                                 
                     \\\\\\\\=...................                                                                 
                       \\\\===............==..                                                                  
                          ===..=.....=======                                                                  
                            ===============                                                                   
                             = =====   =                                                                      
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
`,Ze=`                                                                                                              
                                                                      ~~~                                     
       //////////                                                    =~~~                                     
    //////////////                                                   =.~~.                                    
    ///,,,/////////                                                 ==.~~.                                    
   ////,/,,////////                                                 =..~~.                                    
   ///,b,,,//,,,//////                                             ==. ~..                                    
  ///,,,,,,,,,,,,,/////                                           ===.~~.                                     
  ///,,,,,,/,,///,,/,//             =                             =..~~~.                                     
   //,,,/,,,,//,,,/,,,//       == ======                         ==.~~~..                                     
   ///,,,,/////,//,,,,//   == ============                       =t.~~~..                                     
   //////,/////,,,,/,,/// ======...====..==                     ==..~~..                                      
    /////,,,///,,/,,/////===..............== =                ===..~~...                                      
     //////////,,//,//////=................======  = =   == ====...~~..                                       
    //////,,,,//,,,/////........................==============.....~~..                                       
    ///,,/,,/,,///,,////.................t.............===........:~~:.                                       
    ///,,,/,,,//,,,///,...........oo...............................~~..                                       
    ///,/,,/,,//,//,,,,......... ooo+@.............==.......===....~~~..                                      
    ///,,///,,//,,,,,,//..........oo..............===============...~~..                                      
     ///,,,,,/////,,,,,/+........................===   == =    ====.~~..                                      
     //,,,//,,////,,,,,,.......................====             ===.~~..                                      
     //,/,,/,////,,,/////=...................==                  =...~~.                                      
     //,,/,,,,,/,,,,/////===............==..==                   ==..~~..                                     
    ////,,,,,/,,/,,////// ===..=.....=======                      =..~~~.                                     
    ///////,//,,,,,,,///    ===============                        =..~~                                      
    //////,,,/,////,,,//     = =====   =                           ==.~~                                      
   ///,,///,,,,////,,,///                                           =~~~                                      
   ///,,,////,,///////////                                          =~~~                                      
   //,,/,///,/,,,//////////                                          ~~~                                      
   ///,,,///,/,/,,///  //                                                                                     
   /////,////,,,/,//                                                                                          
    ////,,,//,/,,,///                                                                                         
     /////,//,,/,,///                                                                                         
     /////,,//,,,,///                                                                                         
      /////,,,,/////                                                                                          
       ////////////                                                                                           
        ////////                                                                                              
                                                                                                              
                                                                                                              
                                                                                                              
`;class z extends x{constructor(t,i){super(t,{ch:"+",fg:"yellow"});u(this,"log");u(this,"discovered",!1);u(this,"onDiscover");this.visible=!1,this.log=i.text,this.onDiscover=i.onDiscover}onInteract(t){let i=this.log.split("---"),s=()=>{this.getLevel().textBuffer.displayBox("%c{#098}"+i.shift(),()=>{i.length>0?setTimeout(s.bind(this),0):(this.discovered||this.onDiscover(this),this.discovered=!0,this.setVisual({ch:"+",fg:"#aa0"}))})};return s(),!1}}const et={text:`
::RECOVERED LOGS::  

::MISSION OBJECTIVE::

Distress signal detected from deep-space research vessel INTREPID (DSRV-890). Deployed to the edge of known space for priority research of potential new energy resource.

Primary objective: locate INTREPID and recover classified research data.  
---
::CREW MANIFEST::  

- Commanding Officer: Lo  
- Science Officer: Balthar  
- Engineering Officer: Dax  
- Security Officer: Hanes  
- Security Officer: Argos (reassignment logged)  
---
::MISSION LOGS (LEVEL 5+)::  

...
5671008 - Atmospheric entry initiated; ALERT: velocity exceeds safe parameters.  
5671147 - INTREPID emergency beacon detected to the Southeast.
5671203 - Cryosleep pods A, D, E: activation sequence initiated.  
5672724 - Reserve power systems engaged.  
5679114 - Cryosleep pod C: activation sequence completed.  
5682989 - WARNING: Reserve power levels at 50%.  
5684026 - Emergency override triggered: Cryosleep pod B activated.  
5684035 - CRITICAL WARNING: Reserve power depleted. System shutdown imminent.  


::END LOGS::
`.trim(),onDiscover:r=>r.getLevel().game.display.draw(90,30,"!","red")},tt={text:`
::SCIENCE OFFICER BALTHAR LOGS::

Something went wrong. I woke up and Lo and the sec goons were gone.  I debated waking Dax, but we don't know what happened to the INTREPID's crew.  It may be safer to locate the others and scan for dangers first.
---
I found footprints heading East.  I'll follow them momentarily, but I want to check out some strong energy signatures I'm reading to the West.
---
These crystal formations are incredible!  I've never seen anything like it.  I'm going to take a closer look.
`.trim(),onDiscover:r=>r.getLevel().expandMap(ct)},it={text:`
:COMMANDING OFFICER LO LOGS::

The INTREPID's on the other side of this chasm.  Hanes, grab the extension bridge, we've got to hurry. Let's go, let's go!
`.trim(),onDiscover:r=>null};class st{constructor(e){u(this,"key","0");u(this,"name","Terminal");u(this,"color","green");u(this,"active",!1);u(this,"_fov");u(this,"_logs",[]);u(this,"_level");this._level=e,this._fov=new le.PreciseShadowcasting((t,i)=>{var s;return".@".includes(((s=e.getEntityAt(new g(t,i)))==null?void 0:s.getVisual().ch)||"")},{topology:4})}getFOV(){return{r:3,fov:this._fov,cb:this._fovCb.bind(this)}}_fovCb(e,t,i,s){let n=new g(e,t),o=this._level.getEntityAt(n,!0);if(!o)return;if(o instanceof z){o.visible=!0,this._level.game.display.draw(e,t,o.getVisual().ch,o.getVisual().fg);return}else o=this._level.getEntityAt(n);let a=o.getVisual().ch;a=="."&&this._level.game.display.draw(e,t,a,"#270")}readLog(e){this._logs.push(e),this._level.textBuffer.displayBox(e)}onActivate(e){this.active=!0}onDeactivate(){this.active=!1}}class nt extends x{constructor(e){super(e,{ch:"#",fg:"green"})}onInteract(e){let t=e.getLevel();return t.textBuffer.displayBox("You find a terminal reader. It will be added to your inventory. Press %c{green}[0]%c{} to activate or deactivate it. When activated, it can reveal hidden logs (%c{yellow}+%c{}).",()=>{this.remove();const i=new st(this.getLevel());t.addInventory(i),t.activateItem(i.key)}),!1}}class T extends x{constructor(t,i=!1,s=!1){let n=N.getUniform()>.5?"/":"\\",o=N.getUniform()>.5?"#a0e":"#0ae";super(t,{ch:n,fg:o});u(this,"clearing");this.clearing=i,this.visible=s}onInteract(t){const i="1",s=this.getLevel().activeItem===i;return s?!this.clearing&&s&&this.getLevel().textBuffer.write("Solid crystals block the path."):this.getLevel().textBuffer.write("Giant crystal formations grow like a dense forest, blocking out the light. It's impossible to safely pass through them."),this.clearing&&this.getLevel().activeItem===i}}class ae extends x{constructor(t,i){super(t,{ch:"x",fg:"#bbb"});u(this,"message");this.visible=!1,this.message=i}onInteract(t){return this.getLevel().textBuffer.displayBox(this.message,()=>!0),!1}}const rt=`
It's Balthar.  She's dead.

TO BE CONTINUED...

--END OF CONTENT--
`.trim();class ot{constructor(e){u(this,"key","1");u(this,"name","Torch");u(this,"color","orange");u(this,"active",!1);u(this,"_fov");u(this,"_level");this._level=e,this._fov=new le.RecursiveShadowcasting((t,i)=>{let s=e.getEntityAt(new g(t,i),!0);return s?s instanceof T?(s.visible=!0,s.clearing):s instanceof ae?(s.visible=!0,!1):!"=o".includes(s.getVisual().ch):!1},{topology:8})}getFOV(){return{r:4,fov:this._fov,cb:this._fovCb.bind(this)}}_fovCb(e,t,i,s){let n=new g(e,t),o=this._level.getEntityAt(n);if(o){if(o instanceof T){o.visible=!0;let{ch:a,fg:l}=o.getVisual();this._level.game.display.draw(e,t,a,l)}if(o instanceof T&&o.clearing){let a="#00f",l=Math.min(170,Math.round(255*Math.pow(5/i,1)/5)),h=K.add(K.fromString(a),[l,l,Math.floor(l/2)]);this._level.game.display.draw(e,t,".",K.toHex(h))}else{let{ch:a,fg:l}=o.getVisual(),h=Math.min(170,Math.round(255*Math.pow(5/i,1)/5)),c=K.add(K.fromString(l),[h,h,Math.floor(h/2)]);this._level.game.display.draw(e,t,a,K.toHex(c))}}}onActivate(){this.active=!0}onDeactivate(){this.active=!1}}class lt extends x{constructor(e){super(e,{ch:"T",fg:"orange"})}onInteract(e){let t=e.getLevel();return t.textBuffer.displayBox("You find a torch. Press %c{orange}[1]%c{} to activate or deactivate it.",()=>{this.remove();const i=new ot(this.getLevel());t.addInventory(i)}),!1}}const at=r=>({mapData:Je}),ht=r=>({mapData:Qe,specialEntities:[{xy:new g(41,15),entity:new nt(r)},{xy:new g(37,17),entity:new z(r,et)},{xy:new g(24,19),entity:new z(r,tt)}]}),ct=r=>({mapData:Ze,specialEntities:[{xy:new g(66,10),entity:new lt(r)},{xy:new g(64,17),entity:new z(r,it)},{xy:new g(7,6),entity:new ae(r,rt)}]});let $=0;class ut extends x{constructor(e){super(e,{ch:"o",fg:"white"})}onInteract(e){return $===0?this.getLevel().textBuffer.displayBox("The ship's main power core has been damaged beyond repair.  That explains the reserve power, but it should have lasted for months.  What happened here?  How long was I left behind?  How will I get home? I need to try to find the rest of my crew.  I'll need to venture further out...",()=>this.getLevel().expandMap(ht)):this.getLevel().textBuffer.write("The ship's power core is broken. My crew is gone. What am I going to do?"),$++,!1}}class ft extends x{constructor(e){super(e,{ch:"=",fg:"#950"})}onInteract(e){return this.getLevel().textBuffer.write("This is solid cliff face.  I can't pass."),!1}}class _t extends x{constructor(t,i=!1){super(t,{ch:"I",fg:"#aaa"});u(this,"broken");this.broken=i}onInteract(t){return this.broken?(this.getLevel().textBuffer.write("A bridge was set up across the chasm. However, it has collapsed."),!1):!0}}class dt extends x{constructor(e){super(e,{ch:" ",fg:"white"})}onInteract(e){return this.getLevel().textBuffer.write("A chasm has split the ground in half. It is so deep I can't see the bottom. I'll need to find some other way around."),!1}}function pt(r,e){if("@t+.".includes(r.toLowerCase()))return new x(e,{ch:".",fg:"#444"});switch(r.toLowerCase()){case"o":return new ut(e);case"=":return new ft(e);case"/":return new T(e);case"\\":return new T(e,!1,!0);case",":return new T(e,!0);case"b":return new T(e,!0);case":":return new _t(e,!0);case"~":return new dt(e);default:return new x(e,{ch:r,fg:"red"})}}class gt{constructor(e){u(this,"_size");u(this,"_specialEntities");u(this,"_map");u(this,"_fovCells",[]);u(this,"textBuffer");u(this,"game");u(this,"player");u(this,"_inventory",{});u(this,"activeItem",null);this.game=e,this._specialEntities=[],this._map={},this._size=new g(110,40),this.expandMap(at),this.textBuffer=new $e(this.game);let t=this.getSize(),i=3;this.textBuffer.configure({position:new g(0,0),size:new g(t.x,i)}),this.textBuffer.clear(),this.player=new je(e);let s=new g(37,17);this.setSpecialEntity(this.player,s),e.scheduler.clear(),e.scheduler.add(this.player,!0),this.textBuffer.write(`Where did everyone go?

Use the arrow keys or WASD to move.`)}onKeyDown(e){this.textBuffer.clear(),this.textBuffer.showing?e.key==="Enter"&&(this.textBuffer.clearDisplayBox(),this.updateFOV()):e.key===this.activeItem?this.deactivateItem(e.key):e.key in this._inventory?this.activateItem(e.key):this.player.onKeyDown(e)}activateItem(e){let t=this._inventory[e];this.activeItem=t.key,this._drawInventory(),t.onActivate(),this.updateFOV()}deactivateItem(e){this._inventory[e].onDeactivate(),this.activeItem=null,this._drawInventory(),this.updateFOV()}draw(e){let t=this.getEntityAt(e);if(!t)return;let i=t.getVisual();this.game.display.draw(e.x,e.y,i.ch,i.fg)}expandMap(e){let{mapData:t,specialEntities:i}=e(this.game);this._generateMap(t),i==null||i.forEach(({entity:s,xy:n})=>this.setSpecialEntity(s,n))}addInventory(e){this._inventory[e.key]=e,this._drawInventory()}getSize(){return this._size}setEntity(e,t){e.setPosition(t,this),this._map[t.toString()]=e,this.draw(t)}getEntityAt(e,t=!1){const i=this._specialEntities.find(n=>{var o;return((o=n.getXY())==null?void 0:o.toString())==e.toString()});if(i&&(i.visible||t))return i;const s=this._map[e.toString()];return s&&(s.visible||t)?s:null}setSpecialEntity(e,t){this._specialEntities.push(e),e.setPosition(t,this),this.draw(t)}removeSpecialEntity(e){this._specialEntities=this._specialEntities.filter(t=>t!=e),this.draw(e.getXY())}updateFOV(){for(;this._fovCells.length;)this.draw(this._fovCells.pop());let e=this.activeItem&&this._inventory[this.activeItem].getFOV();if(!e)return;let{x:t,y:i}=this.player.getXY(),{r:s,fov:n,cb:o}=e;n.compute(t,i,s,(a,l,h,c)=>{if(h===0)return;let f=new g(a,l);this.getEntityAt(f)&&(this._fovCells.push(f),o(a,l,h,c))})}_drawInventory(){let{x:e,y:t}=this.getSize();for(let i in this._inventory){let s=parseInt(i)*Math.floor(e/6)+3,n=this.activeItem===i?"* ":"  ";this.game.display.drawText(s,t-1,`%c{${this._inventory[i].color}}[${i}]%c{} `+n+this._inventory[i].name)}}_generateMap(e){let t=e.split(`
`);for(let i=0;i<this._size.y;i++)for(let s=0;s<this._size.x;s++){let n=t[i][s];if(n===" ")continue;let o=new g(s,i),a=this.getEntityAt(o),l=pt(n,this.game);this.setEntity(l,o),a&&(l.visible=a.visible),this.draw(o)}}}class mt{constructor(e){u(this,"size",new g(110,40));u(this,"game");u(this,"_levelData",We);u(this,"_state",1);u(this,"_interval");this.game=e,this._generateMap();let t=!0;this._interval=setInterval(()=>{this.game.display.draw(33,17,"+",t?"#0f0":"#0a0"),this.game.display.draw(35,17,"+",t?"#0f0":"#0a0"),t=!t},1e3)}draw(e){this._generateMap()}onKeyDown(e){e.key==="Enter"&&(this._state===1?(this._state++,clearInterval(this._interval),this._generateMap()):this._state===2&&(this._clear(),this.game.switchLevel(new gt(this.game))))}getSize(){return this.size}_clear(){for(let e=0;e<this.size.y;e++)for(let t=0;t<this.size.x;t++)this.game.display.draw(t,e," ",null,null)}_generateMap(){for(let e=0;e<this.size.y;e++)for(let t=0;t<this.size.x;t++){let i=this._levelData[e][t];this._state===1?([11,15,19,23,27,31].includes(e)&&(i=" "),this.game.display.drawText(32,38,"%c{#ff0}Press [Enter] to wake up from cryosleep...")):this._state===2&&(e==17&&[33,35].includes(t)&&(i="x"),e==17&&t===34&&(i=" "),e==17&&t===38&&(i="@"));let s=i==="x"?"#f00":i==="+"?"#0f0":i==="@"?"#ff0":"-\\/".includes(i)?"#666":"#ddd";e===11&&(s="#f00"),e===38&&(s="#ff0"),e<10&&(s="#f0f"),e<6&&(s="#0af"),e<4&&(s="#0ff"),this.game.display.draw(t,e,i,s)}}}class wt{constructor(){u(this,"scheduler");u(this,"engine");u(this,"level");u(this,"display");u(this,"HANDLED_KEYS",["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","w","a","s","d","Enter","Escape"," "]);this.scheduler=new Xe.Speed,this.engine=new qe(this.scheduler);let e=window.innerWidth/90;window.addEventListener("resize",()=>{e=window.innerWidth/90,this.display.setOptions({fontSize:e})}),this.display=new P({fontSize:e});const t=this.display.getContainer();t.classList.add("max-h-screen","max-w-full"),document.body.appendChild(t);let i=new mt(this);this.level=i,this.switchLevel(i),this.engine.start(),window.addEventListener("keydown",this.onKeyDown.bind(this))}onKeyDown(e){this.HANDLED_KEYS.includes(e.key)&&e.preventDefault(),this.level.onKeyDown(e)}switchLevel(e){this.level=e;let t=e.getSize();this.display.setOptions({width:t.x,height:t.y})}}window.addEventListener("load",he);function he(r){switch(r.type){case"load":new wt}window.removeEventListener("load",he)}
